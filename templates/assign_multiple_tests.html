{% extends "base.html" %}

{% block title %}Assign Multiple Tests - Pathology Lab{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-clipboard-list me-2"></i>Assign Multiple Tests to Patient
            </h1>
            <div>
                <a href="{{ url_for('assign_test') }}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-file-alt me-2"></i>Single Test Assignment
                </a>
                <a href="{{ url_for('patient_tests') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Test Orders
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <form method="POST" id="multipleTestForm">
            {{ form.hidden_tag() }}
            
            <!-- Patient and General Information -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Patient & General Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="{{ form.patient_id.id }}" class="form-label">{{ form.patient_id.label.text }}</label>
                            {{ form.patient_id(class="form-select", id="patientSelect") }}
                            {% if form.patient_id.errors %}
                                <div class="text-danger">
                                    {% for error in form.patient_id.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <label for="{{ form.date_ordered.id }}" class="form-label">{{ form.date_ordered.label.text }}</label>
                            {{ form.date_ordered(class="form-control") }}
                            {% if form.date_ordered.errors %}
                                <div class="text-danger">
                                    {% for error in form.date_ordered.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <label for="{{ form.sample_collector.id }}" class="form-label">{{ form.sample_collector.label.text }}</label>
                            {{ form.sample_collector(class="form-select") }}
                            {% if form.sample_collector.errors %}
                                <div class="text-danger">
                                    {% for error in form.sample_collector.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Selected Tests</label>
                            <div class="bg-light p-2 rounded">
                                <span id="selectedCount" class="badge bg-primary">0</span> tests selected
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="{{ form.notes.id }}" class="form-label">{{ form.notes.label.text }}</label>
                            {{ form.notes(class="form-control", rows="2", placeholder="General notes for all test orders...") }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Selection Grid -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-flask me-2"></i>Available Tests - Select Multiple
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="testSearch" placeholder="Search tests by name...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="categoryFilter">
                                <option value="">All Categories</option>
                                <option value="Blood">Blood Test</option>
                                <option value="Urine">Urine Test</option>
                                <option value="Stool">Stool Test</option>
                                <option value="Imaging">Imaging</option>
                                <option value="Biopsy">Biopsy</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary w-100" id="selectAllBtn">
                                <i class="fas fa-check-double me-2"></i>Select All Visible
                            </button>
                        </div>
                    </div>

                    <!-- Tests Grid -->
                    <div class="row" id="testsGrid">
                        {% for test in tests %}
                        <div class="col-md-6 col-lg-4 mb-3 test-card" data-category="{{ test.category or '' }}" data-name="{{ test.name.lower() }}">
                            <div class="card h-100 test-item" data-test-id="{{ test.id }}">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input test-checkbox" type="checkbox" value="{{ test.id }}" id="test{{ test.id }}">
                                        <label class="form-check-label w-100" for="test{{ test.id }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title mb-1">{{ test.name }}</h6>
                                                    {% if test.category %}
                                                        <span class="badge bg-secondary mb-2">{{ test.category }}</span>
                                                    {% endif %}
                                                    {% if test.description %}
                                                        <p class="card-text small text-muted mb-2">{{ test.description[:60] }}{% if test.description|length > 60 %}...{% endif %}</p>
                                                    {% endif %}
                                                    <div class="small">
                                                        <strong class="text-success">${{ "%.2f"|format(test.cost) }}</strong>
                                                        {% if test.normal_range %}
                                                            <br><span class="text-muted">Range: {{ test.normal_range }}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Selected Tests Summary -->
            <div class="card mb-4" id="selectedTestsCard" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list-check me-2"></i>Selected Tests Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm" id="selectedTestsTable">
                            <thead>
                                <tr>
                                    <th>Test Name</th>
                                    <th>Category</th>
                                    <th>Cost</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="selectedTestsBody">
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <th colspan="2">Total Cost:</th>
                                    <th id="totalCost">$0.00</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payment Collection Section -->
            <div class="card mb-4" id="paymentSection" style="display: none;">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-dollar-sign me-2"></i>Payment Collection (Optional)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-calculator me-2"></i>Bill Summary</h6>
                                <p class="mb-1"><strong>Total Test Cost:</strong> <span id="billTotalCost">$0.00</span></p>
                                <p class="mb-1"><strong>Advance Payment:</strong> <span id="billAdvanceAmount">$0.00</span></p>
                                <p class="mb-0"><strong>Remaining Amount:</strong> <span id="billRemainingAmount">$0.00</span></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="collectPayment" name="collect_payment">
                                <label class="form-check-label" for="collectPayment">
                                    <strong>Collect Advance Payment Now</strong>
                                </label>
                            </div>
                            <div id="paymentFields" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Advance Payment Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" name="advance_amount" id="advanceAmount" class="form-control"
                                               step="0.01" min="0" placeholder="0.00">
                                    </div>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="pay25Percent">25%</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="pay50Percent">50%</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="pay75Percent">75%</button>
                                        <button type="button" class="btn btn-sm btn-outline-success" id="payFull">100%</button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Payment Method</label>
                                        <select name="payment_method" class="form-select">
                                            <option value="cash">Cash</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="upi">UPI</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="cheque">Cheque</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Reference Number (Optional)</label>
                                        <input type="text" name="payment_reference" class="form-control"
                                               placeholder="Transaction ID, Receipt #">
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <label class="form-label">Payment Notes (Optional)</label>
                                    <textarea name="payment_notes" class="form-control" rows="2"
                                              placeholder="Additional notes about this payment..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{{ url_for('patient_tests') }}" class="btn btn-secondary me-md-2">Cancel</a>
                {{ form.submit(class="btn btn-success btn-lg", id="submitBtn", disabled=true) }}
            </div>

            <!-- Hidden inputs for selected test IDs -->
            <div id="hiddenTestInputs"></div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const testCheckboxes = document.querySelectorAll('.test-checkbox');
    const selectedTestsCard = document.getElementById('selectedTestsCard');
    const selectedTestsBody = document.getElementById('selectedTestsBody');
    const selectedCount = document.getElementById('selectedCount');
    const totalCostElement = document.getElementById('totalCost');
    const submitBtn = document.getElementById('submitBtn');
    const hiddenTestInputs = document.getElementById('hiddenTestInputs');
    const testSearch = document.getElementById('testSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const selectAllBtn = document.getElementById('selectAllBtn');
    
    let selectedTests = new Map();
    let totalCost = 0;

    // Test data for JavaScript
    const testData = {
        {% for test in tests %}
        {{ test.id }}: {
            id: {{ test.id }},
            name: "{{ test.name }}",
            category: "{{ test.category or '' }}",
            cost: {{ test.cost }},
            description: "{{ test.description or '' }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    // Handle test selection
    testCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const testId = parseInt(this.value);
            const testCard = this.closest('.test-item');
            
            if (this.checked) {
                selectedTests.set(testId, testData[testId]);
                testCard.classList.add('border-success', 'bg-light');
            } else {
                selectedTests.delete(testId);
                testCard.classList.remove('border-success', 'bg-light');
            }
            
            updateSelectedTestsDisplay();
        });
    });

    // Update selected tests display
    function updateSelectedTestsDisplay() {
        selectedCount.textContent = selectedTests.size;

        if (selectedTests.size === 0) {
            selectedTestsCard.style.display = 'none';
            submitBtn.disabled = true;
            document.getElementById('paymentSection').style.display = 'none';
        } else {
            selectedTestsCard.style.display = 'block';
            submitBtn.disabled = false;
            document.getElementById('paymentSection').style.display = 'block';
        }

        // Update table
        selectedTestsBody.innerHTML = '';
        totalCost = 0;

        // Update hidden inputs
        hiddenTestInputs.innerHTML = '';

        selectedTests.forEach((test, testId) => {
            // Add to table
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${test.name}</td>
                <td><span class="badge bg-secondary">${test.category || 'N/A'}</span></td>
                <td>$${test.cost.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTest(${testId})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            selectedTestsBody.appendChild(row);

            // Add hidden input
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'test_ids[]';
            hiddenInput.value = testId;
            hiddenTestInputs.appendChild(hiddenInput);

            totalCost += test.cost;
        });

        totalCostElement.textContent = `$${totalCost.toFixed(2)}`;
        updatePaymentSummary();
    }

    // Update payment summary
    function updatePaymentSummary() {
        document.getElementById('billTotalCost').textContent = `$${totalCost.toFixed(2)}`;

        const advanceAmount = parseFloat(document.getElementById('advanceAmount').value) || 0;
        const remainingAmount = Math.max(0, totalCost - advanceAmount);

        document.getElementById('billAdvanceAmount').textContent = `$${advanceAmount.toFixed(2)}`;
        document.getElementById('billRemainingAmount').textContent = `$${remainingAmount.toFixed(2)}`;
    }

    // Remove test function (global scope)
    window.removeTest = function(testId) {
        const checkbox = document.getElementById(`test${testId}`);
        checkbox.checked = false;
        checkbox.dispatchEvent(new Event('change'));
    };

    // Search functionality
    testSearch.addEventListener('input', function() {
        filterTests();
    });

    categoryFilter.addEventListener('change', function() {
        filterTests();
    });

    function filterTests() {
        const searchTerm = testSearch.value.toLowerCase();
        const selectedCategory = categoryFilter.value;
        const testCards = document.querySelectorAll('.test-card');
        
        testCards.forEach(card => {
            const testName = card.dataset.name;
            const testCategory = card.dataset.category;
            
            const matchesSearch = testName.includes(searchTerm);
            const matchesCategory = !selectedCategory || testCategory === selectedCategory;
            
            if (matchesSearch && matchesCategory) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Select all visible tests
    selectAllBtn.addEventListener('click', function() {
        const visibleCheckboxes = document.querySelectorAll('.test-card:not([style*="display: none"]) .test-checkbox');
        const allChecked = Array.from(visibleCheckboxes).every(cb => cb.checked);
        
        visibleCheckboxes.forEach(checkbox => {
            if (allChecked) {
                checkbox.checked = false;
            } else {
                checkbox.checked = true;
            }
            checkbox.dispatchEvent(new Event('change'));
        });
        
        selectAllBtn.innerHTML = allChecked ?
            '<i class="fas fa-check-double me-2"></i>Select All Visible' :
            '<i class="fas fa-times me-2"></i>Deselect All Visible';
    });

    // Payment handling
    const collectPaymentCheckbox = document.getElementById('collectPayment');
    const paymentFields = document.getElementById('paymentFields');
    const advanceAmountInput = document.getElementById('advanceAmount');

    collectPaymentCheckbox.addEventListener('change', function() {
        if (this.checked) {
            paymentFields.style.display = 'block';
        } else {
            paymentFields.style.display = 'none';
            advanceAmountInput.value = '';
            updatePaymentSummary();
        }
    });

    // Quick payment percentage buttons
    document.getElementById('pay25Percent').addEventListener('click', function() {
        advanceAmountInput.value = (totalCost * 0.25).toFixed(2);
        updatePaymentSummary();
    });

    document.getElementById('pay50Percent').addEventListener('click', function() {
        advanceAmountInput.value = (totalCost * 0.50).toFixed(2);
        updatePaymentSummary();
    });

    document.getElementById('pay75Percent').addEventListener('click', function() {
        advanceAmountInput.value = (totalCost * 0.75).toFixed(2);
        updatePaymentSummary();
    });

    document.getElementById('payFull').addEventListener('click', function() {
        advanceAmountInput.value = totalCost.toFixed(2);
        updatePaymentSummary();
    });

    // Update payment summary when amount changes
    advanceAmountInput.addEventListener('input', updatePaymentSummary);
});
</script>
{% endblock %}
