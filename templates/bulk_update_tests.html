{% extends "base.html" %}

{% block title %}Bulk Update Tests - Pathology Lab{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-edit me-2"></i>Bulk Update Test Orders
            </h1>
            <div>
                <a href="{{ url_for('patient_tests') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Test Orders
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filters Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filter Tests for Bulk Update
                </h6>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('bulk_update_tests') }}">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="">All Statuses</option>
                                <option value="Pending" {{ 'selected' if status_filter == 'Pending' }}>Pending</option>
                                <option value="Completed" {{ 'selected' if status_filter == 'Completed' }}>Completed</option>
                                <option value="Cancelled" {{ 'selected' if status_filter == 'Cancelled' }}>Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Patient</label>
                            <select name="patient" class="form-select">
                                <option value="">All Patients</option>
                                {% for patient in patients %}
                                <option value="{{ patient.id }}" {{ 'selected' if patient_filter == patient.id|string }}>{{ patient.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date From</label>
                            <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date To</label>
                            <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Filter
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Update Form -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Test Orders - Select for Bulk Update ({{ patient_tests|length }})
                    </h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-success" id="bulkUpdateBtn" style="display: none;">
                            <i class="fas fa-save me-2"></i>Update Selected Tests
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="selectAllBtn">
                            <i class="fas fa-check-square me-2"></i>Select All
                        </button>
                        <button type="button" class="btn btn-outline-warning" id="selectByPatientBtn">
                            <i class="fas fa-user-check me-2"></i>Select by Patient
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if patient_tests %}
                <form id="bulkUpdateForm" method="POST" action="{{ url_for('process_bulk_update') }}">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th width="3%">
                                        <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
                                    </th>
                                    <th>Patient</th>
                                    <th>Test</th>
                                    <th>Date Ordered</th>
                                    <th>Current Status</th>
                                    <th>New Status</th>
                                    <th>Results</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pt in patient_tests %}
                                <tr class="test-row" data-patient-id="{{ pt.patient.id }}" data-patient-name="{{ pt.patient.full_name }}">
                                    <td>
                                        <input type="checkbox" name="selected_tests[]" value="{{ pt.id }}" 
                                               class="form-check-input test-checkbox" data-patient-id="{{ pt.patient.id }}">
                                    </td>
                                    <td>
                                        <strong>{{ pt.patient.full_name }}</strong><br>
                                        <small class="text-muted">{{ pt.patient.phone }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ pt.test.name }}</strong><br>
                                        <small class="text-muted">${{ "%.2f"|format(pt.test.cost) }}</small>
                                    </td>
                                    <td>
                                        {{ pt.date_ordered.strftime('%Y-%m-%d') }}<br>
                                        {% if pt.date_completed %}
                                            <small class="text-success">Completed: {{ pt.date_completed.strftime('%Y-%m-%d') }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if pt.status == 'Completed' else 'warning' if pt.status == 'Pending' else 'secondary' }}">
                                            {{ pt.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <select name="statuses[]" class="form-select form-select-sm status-select" disabled>
                                            <option value="" selected>Keep Current</option>
                                            <option value="Pending">Pending</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Cancelled">Cancelled</option>
                                        </select>
                                    </td>
                                    <td>
                                        <textarea name="results[]" class="form-control form-control-sm" rows="2" 
                                                  placeholder="Enter results..." disabled>{{ pt.results or '' }}</textarea>
                                    </td>
                                    <td>
                                        <textarea name="notes[]" class="form-control form-control-sm" rows="2" 
                                                  placeholder="Additional notes..." disabled>{{ pt.notes or '' }}</textarea>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bulk Update Controls -->
                    <div id="bulkUpdateControls" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>Bulk Update Selected Tests</h6>
                                    <p class="mb-1">Selected: <span id="selectedCount">0</span> tests</p>
                                    <p class="mb-0">Patients: <span id="selectedPatients">-</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Update All Selected Status To:</label>
                                <select name="bulk_status" class="form-select" id="bulkStatusSelect">
                                    <option value="">Keep Individual Status</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Sample Collector for All:</label>
                                <select name="bulk_sample_collector" class="form-select">
                                    <option value="">Keep Current</option>
                                    {% for collector in collectors %}
                                    <option value="{{ collector.name }}">{{ collector.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Add Notes to All Selected:</label>
                                <textarea name="bulk_notes" class="form-control" rows="2" 
                                          placeholder="These notes will be added to all selected tests..."></textarea>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="button" class="btn btn-secondary" id="cancelBulkUpdate">
                                        <i class="fas fa-times me-2"></i>Cancel Selection
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>Update Selected Tests
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-5">
                    <h5 class="text-muted">No test orders found</h5>
                    <p class="text-muted">No test orders match the current filters.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const testCheckboxes = document.querySelectorAll('.test-checkbox');
    const bulkUpdateBtn = document.getElementById('bulkUpdateBtn');
    const bulkUpdateControls = document.getElementById('bulkUpdateControls');
    const selectedCount = document.getElementById('selectedCount');
    const selectedPatients = document.getElementById('selectedPatients');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const selectByPatientBtn = document.getElementById('selectByPatientBtn');
    const bulkStatusSelect = document.getElementById('bulkStatusSelect');
    const cancelBulkUpdate = document.getElementById('cancelBulkUpdate');

    // Handle individual checkbox changes
    testCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const row = this.closest('.test-row');
            const statusSelect = row.querySelector('.status-select');
            const resultTextarea = row.querySelector('textarea[name="results[]"]');
            const notesTextarea = row.querySelector('textarea[name="notes[]"]');
            
            if (this.checked) {
                row.classList.add('table-warning');
                statusSelect.disabled = false;
                resultTextarea.disabled = false;
                notesTextarea.disabled = false;
            } else {
                row.classList.remove('table-warning');
                statusSelect.disabled = true;
                resultTextarea.disabled = true;
                notesTextarea.disabled = true;
            }
            
            updateBulkControls();
        });
    });

    // Select all functionality
    selectAllCheckbox.addEventListener('change', function() {
        testCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
            checkbox.dispatchEvent(new Event('change'));
        });
    });

    selectAllBtn.addEventListener('click', function() {
        const allChecked = Array.from(testCheckboxes).every(cb => cb.checked);
        testCheckboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
            checkbox.dispatchEvent(new Event('change'));
        });
        selectAllCheckbox.checked = !allChecked;
    });

    // Select by patient functionality
    selectByPatientBtn.addEventListener('click', function() {
        const patientSelect = prompt('Enter patient name to select all their tests:');
        if (patientSelect) {
            testCheckboxes.forEach(checkbox => {
                const patientName = checkbox.closest('.test-row').dataset.patientName.toLowerCase();
                if (patientName.includes(patientSelect.toLowerCase())) {
                    checkbox.checked = true;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        }
    });

    // Bulk status update
    bulkStatusSelect.addEventListener('change', function() {
        if (this.value) {
            const checkedBoxes = document.querySelectorAll('.test-checkbox:checked');
            checkedBoxes.forEach(checkbox => {
                const row = checkbox.closest('.test-row');
                const statusSelect = row.querySelector('.status-select');
                statusSelect.value = this.value;
            });
        }
    });

    // Cancel bulk update
    cancelBulkUpdate.addEventListener('click', function() {
        testCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change'));
        });
        selectAllCheckbox.checked = false;
        updateBulkControls();
    });

    function updateBulkControls() {
        const checkedBoxes = document.querySelectorAll('.test-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (count > 0) {
            bulkUpdateBtn.style.display = 'block';
            bulkUpdateControls.style.display = 'block';
            selectedCount.textContent = count;
            
            // Get unique patients
            const patients = new Set();
            checkedBoxes.forEach(checkbox => {
                patients.add(checkbox.closest('.test-row').dataset.patientName);
            });
            selectedPatients.textContent = Array.from(patients).join(', ');
        } else {
            bulkUpdateBtn.style.display = 'none';
            bulkUpdateControls.style.display = 'none';
            selectedCount.textContent = '0';
            selectedPatients.textContent = '-';
        }
    }
});
</script>
{% endblock %}
