{% extends "base.html" %}

{% block title %}Assign Tests - Pathology Lab{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-clipboard-list me-2"></i>Assign Tests to Patient
            </h1>
            <a href="{{ url_for('patient_tests') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Test Orders
            </a>
        </div>
    </div>
</div>

<form method="POST" id="testAssignmentForm">
    {{ form.hidden_tag() }}
    
    <!-- Patient Selection -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-user me-2"></i>Select Patient
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="{{ form.patient_id.id }}" class="form-label">Patient</label>
                    {{ form.patient_id(class="form-select", id="patientSelect") }}
                </div>
                <div class="col-md-4">
                    <label for="{{ form.date_ordered.id }}" class="form-label">Date Ordered</label>
                    {{ form.date_ordered(class="form-control") }}
                </div>
                <div class="col-md-4">
                    <label for="{{ form.sample_collector.id }}" class="form-label">Sample Collector</label>
                    {{ form.sample_collector(class="form-control") }}
                </div>
            </div>
        </div>
    </div>

    <!-- Test Selection -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="fas fa-flask me-2"></i>Select Tests
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for test in tests %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100 test-card" data-test-id="{{ test.id }}" data-test-cost="{{ test.cost }}" data-test-name="{{ test.name }}">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input test-checkbox" type="checkbox" value="{{ test.id }}" id="test_{{ test.id }}">
                                <label class="form-check-label" for="test_{{ test.id }}">
                                    <strong>{{ test.name }}</strong>
                                </label>
                            </div>
                            <p class="small text-muted mb-2">{{ test.description }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary">{{ test.category }}</span>
                                <strong class="text-success">₹{{ "%.2f"|format(test.cost) }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Selected Tests Table -->
    <div class="card mb-4" id="selectedTestsCard" style="display: none;">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Selected Tests
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Test Name</th>
                            <th>Category</th>
                            <th>Cost (₹)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="selectedTestsTableBody">
                        <!-- Selected tests will be added here -->
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="2">Total Amount:</th>
                            <th id="totalCost">₹0.00</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Payment Options -->
    <div class="card mb-4" id="paymentCard" style="display: none;">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="fas fa-credit-card me-2"></i>Payment Options
            </h5>
        </div>
        <div class="card-body">
            <!-- Total Amount Display -->
            <div class="alert alert-info text-center mb-4">
                <h4 class="mb-0">
                    <i class="fas fa-calculator me-2"></i>Total Amount: <span id="displayTotalAmount">₹0.00</span>
                </h4>
            </div>
            
            <!-- Payment Options -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card border-secondary h-100">
                        <div class="card-header bg-secondary text-white text-center">
                            <h6 class="mb-0"><i class="fas fa-clock me-2"></i>No Payment Now</h6>
                        </div>
                        <div class="card-body text-center">
                            <h5 class="text-secondary mb-3">₹0.00</h5>
                            <button type="button" class="btn btn-secondary btn-lg" id="noPaymentBtn">
                                <i class="fas fa-forward me-2"></i>Assign Without Payment
                            </button>
                            <p class="small text-muted mt-2">Full payment will be collected later</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-warning h-100">
                        <div class="card-header bg-warning text-dark text-center">
                            <h6 class="mb-0"><i class="fas fa-hand-holding-usd me-2"></i>Half Payment</h6>
                        </div>
                        <div class="card-body text-center">
                            <h5 class="text-warning mb-3">₹<span id="halfAmount">0.00</span></h5>
                            <button type="button" class="btn btn-warning btn-lg" id="halfPaymentBtn">
                                <i class="fas fa-credit-card me-2"></i>Pay Half Now
                            </button>
                            <p class="small text-muted mt-2">Remaining will be collected after test completion</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white text-center">
                            <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Full Payment</h6>
                        </div>
                        <div class="card-body text-center">
                            <h5 class="text-success mb-3">₹<span id="fullAmount">0.00</span></h5>
                            <button type="button" class="btn btn-success btn-lg" id="fullPaymentBtn">
                                <i class="fas fa-money-check-alt me-2"></i>Pay Full Now
                            </button>
                            <p class="small text-muted mt-2">Complete payment - no remaining balance</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payment Details Form -->
            <div id="paymentDetails" style="display: none;">
                <div class="alert alert-success">
                    <h6><i class="fas fa-info-circle me-2"></i>Payment Summary</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Total Cost:</strong> ₹<span id="paymentTotalCost">0.00</span></p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Paying Now:</strong> ₹<span id="payingNow">0.00</span></p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-0"><strong>Remaining:</strong> ₹<span id="remainingAmount">0.00</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden form fields -->
                <input type="hidden" name="collect_payment" id="collectPayment" value="0">
                <input type="hidden" name="advance_amount" id="advanceAmount">
                <input type="hidden" name="payment_type" id="paymentType">
                
                <div class="row" id="paymentMethodSection" style="display: none;">
                    <div class="col-md-6">
                        <label class="form-label">Payment Method</label>
                        <select name="payment_method" class="form-select" id="paymentMethod">
                            <option value="">Select Payment Method</option>
                            <option value="cash">Cash</option>
                            <option value="card">Credit/Debit Card</option>
                            <option value="upi">UPI</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="cheque">Cheque</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Reference Number</label>
                        <input type="text" name="payment_reference" class="form-control" placeholder="Transaction ID, Receipt #">
                    </div>
                </div>
                
                <div class="mt-3 text-center">
                    <button type="button" class="btn btn-secondary me-2" id="cancelPayment">
                        <i class="fas fa-times me-2"></i>Change Payment Option
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Button -->
    <div class="text-center mb-4">
        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
            <i class="fas fa-save me-2"></i>Assign Tests
        </button>
    </div>
</form>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectedTests = new Map();
    let totalCost = 0;
    
    const selectedTestsCard = document.getElementById('selectedTestsCard');
    const selectedTestsTableBody = document.getElementById('selectedTestsTableBody');
    const paymentCard = document.getElementById('paymentCard');
    const submitBtn = document.getElementById('submitBtn');
    
    // Test selection handling
    document.querySelectorAll('.test-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const testCard = this.closest('.test-card');
            const testId = testCard.dataset.testId;
            const testCost = parseFloat(testCard.dataset.testCost);
            const testName = testCard.dataset.testName;
            const testCategory = testCard.querySelector('.badge').textContent;
            
            if (this.checked) {
                selectedTests.set(testId, {
                    id: testId,
                    name: testName,
                    category: testCategory,
                    cost: testCost
                });
            } else {
                selectedTests.delete(testId);
            }
            
            updateSelectedTestsTable();
            updatePaymentOptions();
        });
    });
    
    function updateSelectedTestsTable() {
        selectedTestsTableBody.innerHTML = '';
        totalCost = 0;
        
        selectedTests.forEach(test => {
            totalCost += test.cost;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${test.name}</td>
                <td><span class="badge bg-secondary">${test.category}</span></td>
                <td>₹${test.cost.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeTest('${test.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            selectedTestsTableBody.appendChild(row);
        });
        
        document.getElementById('totalCost').textContent = `₹${totalCost.toFixed(2)}`;
        
        if (selectedTests.size > 0) {
            selectedTestsCard.style.display = 'block';
            paymentCard.style.display = 'block';
            submitBtn.disabled = false;
        } else {
            selectedTestsCard.style.display = 'none';
            paymentCard.style.display = 'none';
            submitBtn.disabled = true;
        }
    }
    
    function updatePaymentOptions() {
        const halfAmount = totalCost / 2;
        
        document.getElementById('displayTotalAmount').textContent = `₹${totalCost.toFixed(2)}`;
        document.getElementById('halfAmount').textContent = halfAmount.toFixed(2);
        document.getElementById('fullAmount').textContent = totalCost.toFixed(2);
        document.getElementById('paymentTotalCost').textContent = totalCost.toFixed(2);
    }
    
    // Payment option handlers
    document.getElementById('noPaymentBtn').addEventListener('click', function() {
        setPaymentOption(0, 'none');
    });
    
    document.getElementById('halfPaymentBtn').addEventListener('click', function() {
        setPaymentOption(totalCost / 2, 'half');
    });
    
    document.getElementById('fullPaymentBtn').addEventListener('click', function() {
        setPaymentOption(totalCost, 'full');
    });
    
    function setPaymentOption(amount, type) {
        const remainingAmount = totalCost - amount;
        
        document.getElementById('payingNow').textContent = amount.toFixed(2);
        document.getElementById('remainingAmount').textContent = remainingAmount.toFixed(2);
        
        document.getElementById('collectPayment').value = amount > 0 ? '1' : '0';
        document.getElementById('advanceAmount').value = amount.toFixed(2);
        document.getElementById('paymentType').value = type;
        
        document.getElementById('paymentDetails').style.display = 'block';
        
        if (amount > 0) {
            document.getElementById('paymentMethodSection').style.display = 'flex';
        } else {
            document.getElementById('paymentMethodSection').style.display = 'none';
        }
        
        // Hide payment option buttons
        document.querySelector('.row.mb-4').style.display = 'none';
    }
    
    document.getElementById('cancelPayment').addEventListener('click', function() {
        document.getElementById('paymentDetails').style.display = 'none';
        document.querySelector('.row.mb-4').style.display = 'flex';
        
        // Clear form values
        document.getElementById('collectPayment').value = '0';
        document.getElementById('advanceAmount').value = '';
        document.getElementById('paymentType').value = '';
        document.getElementById('paymentMethod').value = '';
    });
    
    // Global function for removing tests
    window.removeTest = function(testId) {
        selectedTests.delete(testId);
        document.getElementById(`test_${testId}`).checked = false;
        updateSelectedTestsTable();
        updatePaymentOptions();
    };
    
    // Form submission
    document.getElementById('testAssignmentForm').addEventListener('submit', function(e) {
        // Add selected test IDs to form
        const testIds = Array.from(selectedTests.keys());
        testIds.forEach(testId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'test_ids';
            input.value = testId;
            this.appendChild(input);
        });
    });
});
</script>
{% endblock %}
