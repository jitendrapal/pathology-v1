{% extends "base.html" %}

{% block title %}Assign Test - Pathology Lab{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-clipboard-list me-2"></i>Assign Test to Patient
            </h1>
            <a href="{{ url_for('patient_tests') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Test Orders
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-form me-2"></i>Test Assignment Details
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <!-- Patient and Test Selection -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.patient_id.id }}" class="form-label">{{ form.patient_id.label.text }}</label>
                            {{ form.patient_id(class="form-select") }}
                            {% if form.patient_id.errors %}
                                <div class="text-danger">
                                    {% for error in form.patient_id.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.test_id.id }}" class="form-label">{{ form.test_id.label.text }}</label>
                            {{ form.test_id(class="form-select") }}
                            {% if form.test_id.errors %}
                                <div class="text-danger">
                                    {% for error in form.test_id.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Date Ordered and Status -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.date_ordered.id }}" class="form-label">{{ form.date_ordered.label.text }} <small class="text-muted">(Optional - defaults to today)</small></label>
                            {{ form.date_ordered(class="form-control") }}
                            {% if form.date_ordered.errors %}
                                <div class="text-danger">
                                    {% for error in form.date_ordered.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.status.id }}" class="form-label">{{ form.status.label.text }}</label>
                            {{ form.status(class="form-select") }}
                            {% if form.status.errors %}
                                <div class="text-danger">
                                    {% for error in form.status.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="mb-3">
                        <label for="{{ form.results.id }}" class="form-label">{{ form.results.label.text }} <small class="text-muted">(Optional - can be added later)</small></label>
                        {{ form.results(class="form-control", rows="4", placeholder="Enter test results here...") }}
                        {% if form.results.errors %}
                            <div class="text-danger">
                                {% for error in form.results.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Sample Collector -->
                    <div class="mb-3">
                        <label for="{{ form.sample_collector.id }}" class="form-label">{{ form.sample_collector.label.text }} <small class="text-muted">(Optional)</small></label>
                        {{ form.sample_collector(class="form-select") }}
                        {% if form.sample_collector.errors %}
                            <div class="text-danger">
                                {% for error in form.sample_collector.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <a href="{{ url_for('add_sample_collector') }}" target="_blank" class="text-decoration-none">
                                <i class="fas fa-plus me-1"></i>Add New Sample Collector
                            </a>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="{{ form.notes.id }}" class="form-label">{{ form.notes.label.text }} <small class="text-muted">(Optional)</small></label>
                        {{ form.notes(class="form-control", rows="3", placeholder="Any additional notes or instructions...") }}
                        {% if form.notes.errors %}
                            <div class="text-danger">
                                {% for error in form.notes.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Payment Collection Section -->
                    <hr class="my-4">
                    <div id="paymentSection" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-dollar-sign me-2"></i>Test Cost & Payment Options
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Test Cost Display -->
                                <div class="alert alert-info text-center mb-4">
                                    <h6 class="mb-1">Selected Test:</h6>
                                    <h4 class="mb-0">
                                        <span id="selectedTestName">Select a test</span> - <span id="testCost" class="text-primary">₹0.00</span>
                                    </h4>
                                </div>

                                <!-- Payment Options -->
                                <div class="row mb-4" id="paymentOptions" style="display: none;">
                                    <div class="col-md-6">
                                        <div class="card border-warning h-100">
                                            <div class="card-header bg-warning text-dark text-center">
                                                <h6 class="mb-0"><i class="fas fa-hand-holding-usd me-2"></i>Pay Half Amount</h6>
                                            </div>
                                            <div class="card-body text-center">
                                                <h5 class="text-warning mb-3">₹<span id="halfAmount">0.00</span></h5>
                                                <button type="button" class="btn btn-warning btn-lg" id="payHalfBtnSingle">
                                                    <i class="fas fa-credit-card me-2"></i>Pay Half Now
                                                </button>
                                                <p class="small text-muted mt-2">Remaining will be collected after test completion</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card border-success h-100">
                                            <div class="card-header bg-success text-white text-center">
                                                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Pay Full Amount</h6>
                                            </div>
                                            <div class="card-body text-center">
                                                <h5 class="text-success mb-3">₹<span id="fullAmount">0.00</span></h5>
                                                <button type="button" class="btn btn-success btn-lg" id="payFullBtnSingle">
                                                    <i class="fas fa-money-check-alt me-2"></i>Pay Full Now
                                                </button>
                                                <p class="small text-muted mt-2">Complete payment - no remaining balance</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Payment Details Form (Hidden initially) -->
                                <div id="paymentDetailsSingle" style="display: none;">
                                    <div class="alert alert-success">
                                        <h6><i class="fas fa-info-circle me-2"></i>Payment Details</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <p class="mb-1"><strong>Test Cost:</strong> ₹<span id="displayTestCost">0.00</span></p>
                                            </div>
                                            <div class="col-md-4">
                                                <p class="mb-1"><strong>Paying Now:</strong> ₹<span id="payingNowSingle">0.00</span></p>
                                            </div>
                                            <div class="col-md-4">
                                                <p class="mb-0"><strong>Remaining:</strong> ₹<span id="remainingAmountSingle">0.00</span></p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Hidden form fields -->
                                    <input type="hidden" name="collect_payment" value="1">
                                    <input type="hidden" name="advance_amount" id="selectedAmountSingle">
                                    <input type="hidden" name="payment_type" id="selectedPaymentTypeSingle">

                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Payment Method</label>
                                            <select name="payment_method" class="form-select" required>
                                                <option value="">Select Payment Method</option>
                                                <option value="cash">Cash</option>
                                                <option value="card">Credit/Debit Card</option>
                                                <option value="upi">UPI</option>
                                                <option value="bank_transfer">Bank Transfer</option>
                                                <option value="cheque">Cheque</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Reference Number</label>
                                            <input type="text" name="payment_reference" class="form-control"
                                                   placeholder="Transaction ID, Receipt #">
                                        </div>
                                    </div>

                                    <div class="mt-3 text-center">
                                        <button type="button" class="btn btn-secondary me-2" id="cancelPaymentSingle">
                                            <i class="fas fa-times me-2"></i>Cancel Payment
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                                    <textarea name="payment_notes" class="form-control" rows="2"
                                              placeholder="Additional notes about this payment..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('patient_tests') }}" class="btn btn-secondary me-md-2">Cancel</a>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const testSelect = document.querySelector('select[name="test_id"]');
    const paymentSection = document.getElementById('paymentSection');
    const paymentOptions = document.getElementById('paymentOptions');
    const payHalfBtnSingle = document.getElementById('payHalfBtnSingle');
    const payFullBtnSingle = document.getElementById('payFullBtnSingle');
    const paymentDetailsSingle = document.getElementById('paymentDetailsSingle');
    const cancelPaymentSingle = document.getElementById('cancelPaymentSingle');

    let currentTestCost = 0;
    let currentTestName = '';

    // Test cost and name data
    const testData = {
        {% for test in tests %}
        {{ test.id }}: {
            cost: {{ test.cost }},
            name: "{{ test.name }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    // Update test cost when test selection changes
    testSelect.addEventListener('change', function() {
        if (this.value && testData[this.value]) {
            currentTestCost = testData[this.value].cost;
            currentTestName = testData[this.value].name;

            // Show payment section
            paymentSection.style.display = 'block';
            paymentOptions.style.display = 'flex';

            // Update displays
            document.getElementById('selectedTestName').textContent = currentTestName;
            document.getElementById('testCost').textContent = `₹${currentTestCost.toFixed(2)}`;
            document.getElementById('displayTestCost').textContent = currentTestCost.toFixed(2);

            // Update payment amounts
            const halfAmount = currentTestCost / 2;
            document.getElementById('halfAmount').textContent = halfAmount.toFixed(2);
            document.getElementById('fullAmount').textContent = currentTestCost.toFixed(2);
        } else {
            // Hide payment section
            paymentSection.style.display = 'none';
            currentTestCost = 0;
            currentTestName = '';
        }
    });

    // Pay Half button
    payHalfBtnSingle.addEventListener('click', function() {
        const halfAmount = currentTestCost / 2;
        const remainingAmount = currentTestCost - halfAmount;

        // Update display
        document.getElementById('payingNowSingle').textContent = halfAmount.toFixed(2);
        document.getElementById('remainingAmountSingle').textContent = remainingAmount.toFixed(2);

        // Set hidden form values
        document.getElementById('selectedAmountSingle').value = halfAmount.toFixed(2);
        document.getElementById('selectedPaymentTypeSingle').value = 'half';

        // Show payment details form
        paymentDetailsSingle.style.display = 'block';

        // Hide payment option buttons
        paymentOptions.style.display = 'none';
    });

    // Pay Full button
    payFullBtnSingle.addEventListener('click', function() {
        const fullAmount = currentTestCost;

        // Update display
        document.getElementById('payingNowSingle').textContent = fullAmount.toFixed(2);
        document.getElementById('remainingAmountSingle').textContent = '0.00';

        // Set hidden form values
        document.getElementById('selectedAmountSingle').value = fullAmount.toFixed(2);
        document.getElementById('selectedPaymentTypeSingle').value = 'full';

        // Show payment details form
        paymentDetailsSingle.style.display = 'block';

        // Hide payment option buttons
        paymentOptions.style.display = 'none';
    });

    // Cancel payment
    cancelPaymentSingle.addEventListener('click', function() {
        // Hide payment details
        paymentDetailsSingle.style.display = 'none';

        // Show payment option buttons
        paymentOptions.style.display = 'flex';

        // Clear form values
        document.getElementById('selectedAmountSingle').value = '';
        document.getElementById('selectedPaymentTypeSingle').value = '';
        document.querySelector('select[name="payment_method"]').value = '';
        document.querySelector('input[name="payment_reference"]').value = '';
    });

    // Initialize
    if (testSelect.value) {
        testSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
