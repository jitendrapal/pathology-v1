{% extends "base.html" %}

{% block title %}Patient Registration & Test Assignment{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Progress Indicator -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <h3 class="text-center mb-4">
                                <i class="fas fa-user-plus me-2"></i>Patient Registration & Test Assignment
                            </h3>
                            
                            <!-- Progress Steps -->
                            <div class="progress-steps mb-4">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="step active" id="step1-indicator">
                                            <div class="step-number">1</div>
                                            <div class="step-title">Patient Information</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="step" id="step2-indicator">
                                            <div class="step-number">2</div>
                                            <div class="step-title">Test Selection & Billing</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="progress mt-3">
                                    <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Multi-Step Form -->
            <form id="multiStepForm" method="POST" action="{{ url_for('multi_step_registration') }}">
                <!-- Step 1: Patient Information -->
                <div class="step-content" id="step1">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-user me-2"></i>Step 1: Patient Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Personal Information -->
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">Personal Details</h6>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Title *</label>
                                                <select class="form-select" name="title" id="title" required onchange="updateGenderFromTitle()">
                                                    <option value="">Select Title</option>
                                                    <option value="Mr." data-gender="Male">Mr.</option>
                                                    <option value="Mrs." data-gender="Female">Mrs.</option>
                                                    <option value="Miss" data-gender="Female">Miss</option>
                                                    <option value="Dr." data-gender="">Dr.</option>
                                                    <option value="Prof." data-gender="">Prof.</option>
                                                    <option value="Master" data-gender="Male">Master</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label class="form-label">First Name *</label>
                                                <input type="text" class="form-control" name="first_name" required>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" name="last_name" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Date of Birth *</label>
                                        <input type="date" class="form-control" name="date_of_birth" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Gender *</label>
                                        <div class="mt-2">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="gender" id="gender-male" value="Male" required>
                                                <label class="form-check-label" for="gender-male">
                                                    <i class="fas fa-mars text-primary me-1"></i>Male
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="gender" id="gender-female" value="Female" required>
                                                <label class="form-check-label" for="gender-female">
                                                    <i class="fas fa-venus text-danger me-1"></i>Female
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="gender" id="gender-other" value="Other" required>
                                                <label class="form-check-label" for="gender-other">
                                                    <i class="fas fa-genderless text-secondary me-1"></i>Other
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Phone Number *</label>
                                        <input type="tel" class="form-control" name="phone" required>
                                    </div>
                                </div>
                                
                                <!-- Contact & Medical Information -->
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">Contact & Medical Details</h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" name="email">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Address</label>
                                        <textarea class="form-control" name="address" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Emergency Contact</label>
                                        <input type="text" class="form-control" name="emergency_contact">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Medical History</label>
                                        <textarea class="form-control" name="medical_history" rows="3" placeholder="Any relevant medical conditions, allergies, medications..."></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Referring Doctor</label>
                                        <input type="text" class="form-control" name="referring_doctor">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Navigation Buttons -->
                            <div class="row mt-4">
                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="nextStep()">
                                        Next: Test Selection <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Test Selection & Billing -->
                <div class="step-content d-none" id="step2">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5><i class="fas fa-vial me-2"></i>Step 2: Test Selection & Billing</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Test Selection -->
                                <div class="col-md-8">
                                    <h6 class="text-success mb-3">Select Tests</h6>

                                    <!-- Search Test Input -->
                                    <div class="mb-4">
                                        <label class="form-label">Search & Add Tests</label>
                                        <div class="position-relative">
                                            <input type="text" class="form-control" id="test-search" placeholder="Type test name to search..." autocomplete="off">
                                            <div id="test-suggestions" class="position-absolute w-100 bg-white border rounded shadow-sm d-none" style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                                                <!-- Suggestions will be populated here -->
                                            </div>
                                        </div>
                                        <small class="text-muted">Start typing to see test suggestions with prices</small>
                                    </div>

                                    <!-- Selected Tests Display -->
                                    <div class="mb-3">
                                        <h6 class="text-muted">Selected Tests</h6>
                                        <div id="selected-tests-display" class="border rounded p-3 bg-light">
                                            <p class="text-muted mb-0">No tests selected. Use the search box above to add tests.</p>
                                        </div>
                                    </div>

                                    <!-- Quick Test Categories (Optional) -->
                                    <div class="mb-3">
                                        <h6 class="text-muted">Quick Add - Common Tests</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="d-grid gap-2">
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addQuickTest('Complete Blood Count (CBC)', 300)">
                                                        <i class="fas fa-plus me-1"></i>CBC - ₹300
                                                    </button>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addQuickTest('Blood Sugar (Fasting)', 150)">
                                                        <i class="fas fa-plus me-1"></i>Blood Sugar - ₹150
                                                    </button>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addQuickTest('Lipid Profile', 500)">
                                                        <i class="fas fa-plus me-1"></i>Lipid Profile - ₹500
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-grid gap-2">
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addQuickTest('Thyroid Profile', 600)">
                                                        <i class="fas fa-plus me-1"></i>Thyroid - ₹600
                                                    </button>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addQuickTest('Urine Analysis', 200)">
                                                        <i class="fas fa-plus me-1"></i>Urine Analysis - ₹200
                                                    </button>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addQuickTest('X-Ray Chest', 250)">
                                                        <i class="fas fa-plus me-1"></i>X-Ray - ₹250
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Custom Test -->
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <h6 class="text-muted">Add Custom Test</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="custom-test-name" placeholder="Enter custom test name">
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="input-group">
                                                        <span class="input-group-text">₹</span>
                                                        <input type="number" class="form-control" id="custom-test-price" placeholder="Price">
                                                    </div>
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-success w-100" onclick="addCustomTest()">
                                                        <i class="fas fa-plus"></i> Add
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Billing Summary -->
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Billing Summary</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="selected-tests">
                                                <p class="text-muted">No tests selected</p>
                                            </div>
                                            
                                            <hr>
                                            
                                            <div class="d-flex justify-content-between">
                                                <strong>Total Amount:</strong>
                                                <strong id="total-amount">₹0</strong>
                                            </div>
                                            
                                            <hr>
                                            
                                            <!-- Payment Options -->
                                            <h6 class="text-success mb-3">Payment Option</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment_option" value="full" id="payment-full" checked>
                                                <label class="form-check-label" for="payment-full">
                                                    Full Payment
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment_option" value="half" id="payment-half">
                                                <label class="form-check-label" for="payment-half">
                                                    Half Payment (50%)
                                                </label>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <div class="d-flex justify-content-between">
                                                    <span>Amount to Pay:</span>
                                                    <strong id="amount-to-pay">₹0</strong>
                                                </div>
                                                <div class="d-flex justify-content-between text-muted">
                                                    <small>Remaining:</small>
                                                    <small id="remaining-amount">₹0</small>
                                                </div>
                                            </div>
                                            
                                            <!-- Payment Method -->
                                            <div class="mt-3">
                                                <label class="form-label">Payment Method</label>
                                                <select class="form-select" name="payment_method">
                                                    <option value="Cash">Cash</option>
                                                    <option value="Card">Card</option>
                                                    <option value="UPI">UPI</option>
                                                    <option value="Bank Transfer">Bank Transfer</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Navigation Buttons -->
                            <div class="row mt-4">
                                <div class="col-6">
                                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="previousStep()">
                                        <i class="fas fa-arrow-left me-2"></i> Back
                                    </button>
                                </div>
                                <div class="col-6 text-end">
                                    <button type="submit" class="btn btn-success btn-lg" id="submit-btn" disabled>
                                        <i class="fas fa-check me-2"></i> Complete Registration
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.progress-steps .step {
    position: relative;
    text-align: center;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.step.active .step-number {
    background-color: #007bff;
    color: white;
}

.step.completed .step-number {
    background-color: #28a745;
    color: white;
}

.step-title {
    font-size: 14px;
    color: #6c757d;
    font-weight: 500;
}

.step.active .step-title {
    color: #007bff;
    font-weight: bold;
}

.test-category .form-check {
    margin-bottom: 8px;
}

.test-checkbox:checked + label {
    font-weight: bold;
    color: #28a745;
}

#selected-tests {
    max-height: 200px;
    overflow-y: auto;
}

.selected-test-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #dee2e6;
}

.selected-test-item:last-child {
    border-bottom: none;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none !important;
}

#test-suggestions {
    border-top: none;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}

.form-check-input.is-invalid {
    border-color: #dc3545;
}

.form-check-input.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}
</style>

<script>
let currentStep = 1;
let totalAmount = 0;
let selectedTests = [];

// Available tests database for search suggestions
const availableTests = [
    {name: "Complete Blood Count (CBC)", price: 300, category: "Blood Test"},
    {name: "Blood Sugar (Fasting)", price: 150, category: "Blood Test"},
    {name: "Blood Sugar (Random)", price: 120, category: "Blood Test"},
    {name: "Blood Sugar (Post Prandial)", price: 140, category: "Blood Test"},
    {name: "HbA1c (Glycated Hemoglobin)", price: 400, category: "Blood Test"},
    {name: "Lipid Profile", price: 500, category: "Blood Test"},
    {name: "Liver Function Test (LFT)", price: 400, category: "Blood Test"},
    {name: "Kidney Function Test (KFT)", price: 350, category: "Blood Test"},
    {name: "Thyroid Profile (T3, T4, TSH)", price: 600, category: "Hormone Test"},
    {name: "Thyroid TSH", price: 200, category: "Hormone Test"},
    {name: "Vitamin D", price: 800, category: "Vitamin Test"},
    {name: "Vitamin B12", price: 600, category: "Vitamin Test"},
    {name: "Iron Studies", price: 450, category: "Blood Test"},
    {name: "Urine Analysis (Routine)", price: 200, category: "Urine Test"},
    {name: "Urine Culture", price: 300, category: "Urine Test"},
    {name: "Stool Analysis", price: 150, category: "Stool Test"},
    {name: "X-Ray Chest", price: 250, category: "Radiology"},
    {name: "X-Ray Abdomen", price: 300, category: "Radiology"},
    {name: "ECG (Electrocardiogram)", price: 200, category: "Cardiology"},
    {name: "Echo Cardiogram", price: 800, category: "Cardiology"},
    {name: "Ultrasound Abdomen", price: 600, category: "Radiology"},
    {name: "Ultrasound Pelvis", price: 650, category: "Radiology"},
    {name: "CT Scan Head", price: 2500, category: "Radiology"},
    {name: "MRI Brain", price: 5000, category: "Radiology"},
    {name: "Hepatitis B Surface Antigen", price: 300, category: "Infection Test"},
    {name: "HIV Test", price: 400, category: "Infection Test"},
    {name: "Malaria Test", price: 150, category: "Infection Test"},
    {name: "Dengue Test", price: 500, category: "Infection Test"},
    {name: "COVID-19 RT-PCR", price: 800, category: "Infection Test"},
    {name: "COVID-19 Antigen", price: 300, category: "Infection Test"}
];

// Title to Gender mapping function
function updateGenderFromTitle() {
    const titleSelect = document.getElementById('title');
    const selectedOption = titleSelect.options[titleSelect.selectedIndex];
    const gender = selectedOption.getAttribute('data-gender');

    if (gender) {
        // Clear all radio buttons first
        document.querySelectorAll('input[name="gender"]').forEach(radio => {
            radio.checked = false;
        });

        // Select the appropriate gender
        const genderRadio = document.querySelector(`input[name="gender"][value="${gender}"]`);
        if (genderRadio) {
            genderRadio.checked = true;
        }
    }
}</script>

<script>

// Test Search Functionality
function initializeTestSearch() {
    const searchInput = document.getElementById('test-search');
    const suggestionsDiv = document.getElementById('test-suggestions');

    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();

        if (query.length < 2) {
            suggestionsDiv.classList.add('d-none');
            return;
        }

        const filteredTests = availableTests.filter(test =>
            test.name.toLowerCase().includes(query) ||
            test.category.toLowerCase().includes(query)
        );

        if (filteredTests.length > 0) {
            let suggestionsHTML = '';
            filteredTests.slice(0, 8).forEach(test => {
                suggestionsHTML += `
                    <div class="suggestion-item p-2 border-bottom" style="cursor: pointer;"
                         onclick="selectTestFromSuggestion('${test.name}', ${test.price})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${test.name}</strong>
                                <small class="text-muted d-block">${test.category}</small>
                            </div>
                            <span class="badge bg-primary">₹${test.price}</span>
                        </div>
                    </div>
                `;
            });

            suggestionsDiv.innerHTML = suggestionsHTML;
            suggestionsDiv.classList.remove('d-none');
        } else {
            suggestionsDiv.innerHTML = '<div class="p-2 text-muted">No tests found</div>';
            suggestionsDiv.classList.remove('d-none');
        }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.classList.add('d-none');
        }
    });
}

function selectTestFromSuggestion(testName, testPrice) {
    // Check if test is already selected
    const existingTest = selectedTests.find(test => test.name === testName);
    if (existingTest) {
        alert('This test is already selected!');
        return;
    }

    // Add test to selected tests
    selectedTests.push({name: testName, price: testPrice});
    totalAmount += testPrice;

    // Clear search input
    document.getElementById('test-search').value = '';
    document.getElementById('test-suggestions').classList.add('d-none');

    // Update displays
    updateSelectedTestsDisplay();
    updateBilling();

    // Enable submit button
    document.getElementById('submit-btn').disabled = false;
}

function addQuickTest(testName, testPrice) {
    // Check if test is already selected
    const existingTest = selectedTests.find(test => test.name === testName);
    if (existingTest) {
        alert('This test is already selected!');
        return;
    }

    // Add test to selected tests
    selectedTests.push({name: testName, price: testPrice});
    totalAmount += testPrice;

    // Update displays
    updateSelectedTestsDisplay();
    updateBilling();

    // Enable submit button
    document.getElementById('submit-btn').disabled = false;
}

function removeTest(testName) {
    const testIndex = selectedTests.findIndex(test => test.name === testName);
    if (testIndex > -1) {
        totalAmount -= selectedTests[testIndex].price;
        selectedTests.splice(testIndex, 1);

        updateSelectedTestsDisplay();
        updateBilling();

        // Disable submit button if no tests
        document.getElementById('submit-btn').disabled = selectedTests.length === 0;
    }
}

function updateSelectedTestsDisplay() {
    const displayDiv = document.getElementById('selected-tests-display');

    if (selectedTests.length === 0) {
        displayDiv.innerHTML = '<p class="text-muted mb-0">No tests selected. Use the search box above to add tests.</p>';
        return;
    }

    let html = '';
    selectedTests.forEach(test => {
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded border">
                <div>
                    <strong>${test.name}</strong>
                    <span class="badge bg-success ms-2">₹${test.price}</span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTest('${test.name}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });

    displayDiv.innerHTML = html;
}

// Step Navigation
function nextStep() {
    if (validateStep1()) {
        document.getElementById('step1').classList.add('d-none');
        document.getElementById('step2').classList.remove('d-none');

        document.getElementById('step1-indicator').classList.remove('active');
        document.getElementById('step1-indicator').classList.add('completed');
        document.getElementById('step2-indicator').classList.add('active');

        document.getElementById('progress-bar').style.width = '100%';
        currentStep = 2;

        // Initialize test search when entering step 2
        initializeTestSearch();
    }
}

function previousStep() {
    document.getElementById('step2').classList.add('d-none');
    document.getElementById('step1').classList.remove('d-none');
    
    document.getElementById('step2-indicator').classList.remove('active');
    document.getElementById('step1-indicator').classList.remove('completed');
    document.getElementById('step1-indicator').classList.add('active');
    
    document.getElementById('progress-bar').style.width = '50%';
    currentStep = 1;
}

// Validation
function validateStep1() {
    const requiredFields = ['title', 'first_name', 'last_name', 'date_of_birth', 'phone'];
    let isValid = true;

    // Validate text and select fields
    requiredFields.forEach(field => {
        const input = document.querySelector(`[name="${field}"]`);
        if (!input.value.trim()) {
            input.classList.add('is-invalid');
            isValid = false;
        } else {
            input.classList.remove('is-invalid');
        }
    });

    // Validate gender radio buttons
    const genderSelected = document.querySelector('input[name="gender"]:checked');
    if (!genderSelected) {
        document.querySelectorAll('input[name="gender"]').forEach(radio => {
            radio.classList.add('is-invalid');
        });
        isValid = false;
    } else {
        document.querySelectorAll('input[name="gender"]').forEach(radio => {
            radio.classList.remove('is-invalid');
        });
    }

    if (!isValid) {
        alert('Please fill in all required fields marked with * and select gender');
    }

    return isValid;
}

// Test Selection
document.addEventListener('DOMContentLoaded', function() {
    const paymentOptions = document.querySelectorAll('input[name="payment_option"]');

    paymentOptions.forEach(option => {
        option.addEventListener('change', updatePaymentAmount);
    });
});

function updateBilling() {
    displaySelectedTests();
    updatePaymentAmount();

    // Enable/disable submit button
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = selectedTests.length === 0;
}

function displaySelectedTests() {
    const container = document.getElementById('selected-tests');

    if (selectedTests.length === 0) {
        container.innerHTML = '<p class="text-muted">No tests selected</p>';
        document.getElementById('total-amount').textContent = '₹0';
        return;
    }

    let html = '';
    selectedTests.forEach(test => {
        html += `
            <div class="selected-test-item">
                <span>${test.name}</span>
                <span>₹${test.price}</span>
            </div>
        `;
    });

    container.innerHTML = html;
    document.getElementById('total-amount').textContent = `₹${totalAmount}`;
}

function updatePaymentAmount() {
    const paymentOption = document.querySelector('input[name="payment_option"]:checked').value;
    let amountToPay = totalAmount;
    let remainingAmount = 0;
    
    if (paymentOption === 'half') {
        amountToPay = Math.round(totalAmount / 2);
        remainingAmount = totalAmount - amountToPay;
    }
    
    document.getElementById('amount-to-pay').textContent = `₹${amountToPay}`;
    document.getElementById('remaining-amount').textContent = `₹${remainingAmount}`;
}

function addCustomTest() {
    const testName = document.getElementById('custom-test-name').value.trim();
    const testPrice = parseInt(document.getElementById('custom-test-price').value);

    if (!testName || !testPrice || testPrice <= 0) {
        alert('Please enter valid test name and price');
        return;
    }

    // Check if test is already selected
    const existingTest = selectedTests.find(test => test.name === testName);
    if (existingTest) {
        alert('This test is already selected!');
        return;
    }

    // Add to selected tests
    selectedTests.push({name: testName, price: testPrice});
    totalAmount += testPrice;

    // Clear inputs
    document.getElementById('custom-test-name').value = '';
    document.getElementById('custom-test-price').value = '';

    // Update displays
    updateSelectedTestsDisplay();
    updateBilling();

    // Enable submit button
    document.getElementById('submit-btn').disabled = false;
}

// Form Submission
document.getElementById('multiStepForm').addEventListener('submit', function(e) {
    if (selectedTests.length === 0) {
        e.preventDefault();
        alert('Please select at least one test');
        return;
    }
    
    // Add selected tests to form data
    const testsInput = document.createElement('input');
    testsInput.type = 'hidden';
    testsInput.name = 'selected_tests';
    testsInput.value = JSON.stringify(selectedTests);
    this.appendChild(testsInput);
    
    // Add total amount
    const totalInput = document.createElement('input');
    totalInput.type = 'hidden';
    totalInput.name = 'total_amount';
    totalInput.value = totalAmount;
    this.appendChild(totalInput);
});
</script>
{% endblock %}
