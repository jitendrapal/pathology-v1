{% extends "base.html" %}

{% block title %}{{ patient.full_name }} - Patient Details - Pathology Lab{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-user me-2"></i>{{ patient.full_name }} - Patient Details
            </h1>
            <div class="btn-group">
                <a href="{{ url_for('edit_patient', id=patient.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-edit me-2"></i>Edit Patient
                </a>
                <a href="{{ url_for('patient_billing', patient_id=patient.id) }}" class="btn btn-warning">
                    <i class="fas fa-dollar-sign me-2"></i>Billing & Payments
                </a>
                <div class="btn-group">
                    <a href="{{ url_for('patient_report', patient_id=patient.id) }}" class="btn btn-info" target="_blank">
                        <i class="fas fa-print me-2"></i>Print Report
                    </a>
                    <a href="{{ url_for('print_patient_report', patient_id=patient.id) }}" class="btn btn-success" target="_blank">
                        <i class="fas fa-file-medical me-2"></i>Print Test Results
                    </a>
                </div>
                <a href="{{ url_for('patients') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Patients
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Patient Information Card - Simplified -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong><i class="fas fa-user me-2"></i>{{ patient.full_name }}</strong>
                    </div>
                    <div class="col-md-3">
                        <span class="badge bg-info">{{ patient.gender }}</span>
                    </div>
                    <div class="col-md-5">
                        <i class="fas fa-phone me-2"></i>{{ patient.phone }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- All Patient Tests - Update in One Place -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-flask me-2"></i>All Assigned Tests - Update Status & Results
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('update_patient_tests', patient_id=patient.id) }}" id="updateTestsForm">
                    
                    {% if patient_tests %}
                    <!-- Existing Tests - New Color-Coded Format -->
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-list me-2"></i>Current Tests ({{ patient_tests|length }})
                    </h6>

                    <!-- Modern Tests Table with Color-Coded Validation -->
                    <div class="table-responsive">
                        <table class="table modern-table">
                            <thead>
                                <tr>
                                    <th style="width: 22%;">Test Name</th>
                                    <th style="width: 12%;">Test Value</th>
                                    <th style="width: 8%;">Unit</th>
                                    <th style="width: 14%;">Normal Range</th>
                                    <th style="width: 12%;">Status</th>
                                    <th style="width: 20%;">Notes</th>
                                    <th style="width: 6%;">Date</th>
                                    <th style="width: 6%;">Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pt in patient_tests %}
                                <tr class="test-row" data-status="{{ pt.status }}">
                                    <!-- Test Name -->
                                    <td>
                                        <div class="fw-bold text-dark" style="font-size: 0.9em;">{{ pt.test.name }}</div>
                                        <small class="text-muted">{{ pt.test.category or 'General' }}</small>
                                        <input type="hidden" name="test_ids[]" value="{{ pt.id }}">
                                    </td>

                                    <!-- Test Value Input with Color Validation -->
                                    <td>
                                        <input type="number"
                                               class="form-control form-control-sm test-result-input test-input-modern"
                                               name="results[]"
                                               value="{{ pt.results or '' }}"
                                               placeholder="Value"
                                               data-min="{{ pt.test.normal_range_min or 0 }}"
                                               data-max="{{ pt.test.normal_range_max or 100 }}"
                                               data-test-id="{{ pt.id }}"
                                               oninput="validateResult(this)"
                                               step="0.01"
                                               style="width: 85px;">
                                    </td>

                                    <!-- Unit -->
                                    <td class="text-center">
                                        <span class="unit-badge-modern">{{ pt.test.unit or 'units' }}</span>
                                    </td>

                                    <!-- Normal Range -->
                                    <td>
                                        <div class="text-center">
                                            <small class="fw-bold text-primary">
                                                {{ pt.test.normal_range_min or 0 }} - {{ pt.test.normal_range_max or 100 }}
                                            </small>
                                            <br><small class="text-muted">{{ pt.test.unit or 'units' }}</small>
                                        </div>
                                    </td>

                                    <!-- Status -->
                                    <td>
                                        <select name="statuses[]" class="form-select form-select-sm status-select-modern">
                                            <option value="Pending" {{ 'selected' if pt.status == 'Pending' }}>Pending</option>
                                            <option value="In Progress" {{ 'selected' if pt.status == 'In Progress' }}>Progress</option>
                                            <option value="Completed" {{ 'selected' if pt.status == 'Completed' }}>Done</option>
                                            <option value="Cancelled" {{ 'selected' if pt.status == 'Cancelled' }}>Cancel</option>
                                        </select>
                                    </td>

                                    <!-- Notes -->
                                    <td>
                                        <textarea name="notes[]" class="form-control form-control-sm notes-textarea-modern"
                                                  rows="1"
                                                  placeholder="Add notes...">{{ pt.notes or '' }}</textarea>
                                    </td>

                                    <!-- Date -->
                                    <td class="text-center">
                                        <small class="text-muted">
                                            {{ pt.date_ordered.strftime('%m/%d') }}
                                            {% if pt.date_completed %}
                                            <br><i class="fas fa-check-circle text-success"></i>
                                            {% endif %}
                                        </small>
                                    </td>

                                    <!-- Cost -->
                                    <td class="text-center">
                                        <span class="fw-bold text-success">â‚¹{{ "%.0f"|format(pt.test.cost) }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <h6>No tests assigned yet</h6>
                        <p class="mb-0">Use the section below to assign new tests to this patient.</p>
                    </div>
                    {% endif %}

                    <!-- Add New Tests Section -->
                    <hr class="my-4">
                    <h6 class="text-success mb-3">
                        <i class="fas fa-plus me-2"></i>Assign New Tests
                    </h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Sample Collector (for new tests)</label>
                            <select name="sample_collector" class="form-select">
                                <option value="">Select Sample Collector</option>
                                {% for collector in collectors %}
                                <option value="{{ collector.name }}">{{ collector.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quick Actions</label>
                            <div class="btn-group w-100">
                                <button type="button" class="btn btn-outline-primary" id="selectCommonTests">
                                    <i class="fas fa-check-double me-1"></i>Select Common Tests
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="clearSelection">
                                    <i class="fas fa-times me-1"></i>Clear Selection
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Available Tests Grid -->
                    <div class="row" id="newTestsGrid">
                        {% for test in all_tests %}
                        {% set is_assigned = patient_tests|selectattr("test.id", "equalto", test.id)|list|length > 0 %}
                        <div class="col-md-6 col-lg-4 mb-2">
                            <div class="card h-100 {{ 'border-secondary bg-light' if is_assigned else '' }}">
                                <div class="card-body p-2">
                                    <div class="form-check">
                                        <input class="form-check-input new-test-checkbox" type="checkbox" 
                                               value="{{ test.id }}" id="newTest{{ test.id }}"
                                               name="new_test_ids[]" {{ 'disabled' if is_assigned else '' }}>
                                        <label class="form-check-label w-100" for="newTest{{ test.id }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title mb-1 {{ 'text-muted' if is_assigned else '' }}">
                                                        {{ test.name }}
                                                        {% if is_assigned %}<small class="text-success">(Already Assigned)</small>{% endif %}
                                                    </h6>
                                                    {% if test.category %}
                                                    <span class="badge bg-secondary mb-1">{{ test.category }}</span>
                                                    {% endif %}
                                                    <div class="small">
                                                        <strong class="text-success">â‚¹{{ "%.2f"|format(test.cost) }}</strong>
                                                        {% if test.normal_range %}
                                                        <br><span class="text-muted">{{ test.normal_range }}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Selected New Tests Table -->
                    <div class="card mt-4" id="selectedNewTestsCard" style="display: none;">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-list me-2"></i>Selected New Tests
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Category</th>
                                            <th>Cost (â‚¹)</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="selectedNewTestsTableBody">
                                        <!-- Selected tests will be added here -->
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <th colspan="2">Total New Tests Cost:</th>
                                            <th id="totalNewTestsCost">â‚¹0.00</th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Options for New Tests -->
                    <div class="card mt-4" id="newTestsPaymentCard" style="display: none;">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-credit-card me-2"></i>Payment Options for New Tests
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Total Amount Display -->
                            <div class="alert alert-info text-center mb-4">
                                <h5 class="mb-0">
                                    <i class="fas fa-calculator me-2"></i>Total New Tests Cost: <span id="displayNewTestsTotal">â‚¹0.00</span>
                                </h5>
                            </div>

                            <!-- Payment Options -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card border-secondary h-100">
                                        <div class="card-header bg-secondary text-white text-center">
                                            <h6 class="mb-0"><i class="fas fa-clock me-2"></i>No Payment Now</h6>
                                        </div>
                                        <div class="card-body text-center">
                                            <h6 class="text-secondary mb-3">â‚¹0.00</h6>
                                            <button type="button" class="btn btn-secondary btn-sm" id="noPaymentNewTestsBtn">
                                                <i class="fas fa-forward me-2"></i>Assign Without Payment
                                            </button>
                                            <p class="small text-muted mt-2">Full payment will be collected later</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark text-center">
                                            <h6 class="mb-0"><i class="fas fa-hand-holding-usd me-2"></i>Half Payment</h6>
                                        </div>
                                        <div class="card-body text-center">
                                            <h6 class="text-warning mb-3">â‚¹<span id="halfNewTestsAmount">0.00</span></h6>
                                            <button type="button" class="btn btn-warning btn-sm" id="halfPaymentNewTestsBtn">
                                                <i class="fas fa-credit-card me-2"></i>Pay Half Now
                                            </button>
                                            <p class="small text-muted mt-2">50% of total amount</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-success h-100">
                                        <div class="card-header bg-success text-white text-center">
                                            <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Full Payment</h6>
                                        </div>
                                        <div class="card-body text-center">
                                            <h6 class="text-success mb-3">â‚¹<span id="fullNewTestsAmount">0.00</span></h6>
                                            <button type="button" class="btn btn-success btn-sm" id="fullPaymentNewTestsBtn">
                                                <i class="fas fa-money-check-alt me-2"></i>Pay Full Now
                                            </button>
                                            <p class="small text-muted mt-2">100% of total amount</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-info h-100">
                                        <div class="card-header bg-info text-white text-center">
                                            <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Custom Amount</h6>
                                        </div>
                                        <div class="card-body text-center">
                                            <div class="input-group input-group-sm mb-3">
                                                <span class="input-group-text">â‚¹</span>
                                                <input type="number" class="form-control" id="customAmountInput" placeholder="0.00" min="0" step="0.01" max="999999">
                                            </div>
                                            <button type="button" class="btn btn-info btn-sm" id="customPaymentNewTestsBtn">
                                                <i class="fas fa-rupee-sign me-2"></i>Pay Custom Amount
                                            </button>
                                            <p class="small text-muted mt-2">Enter any amount you want</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Details Form -->
                            <div id="newTestsPaymentDetails" style="display: none;">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-info-circle me-2"></i>Payment Summary</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <p class="mb-1"><strong>Total Cost:</strong> â‚¹<span id="paymentNewTestsTotal">0.00</span></p>
                                        </div>
                                        <div class="col-md-4">
                                            <p class="mb-1"><strong>Paying Now:</strong> â‚¹<span id="payingNewTestsNow">0.00</span></p>
                                        </div>
                                        <div class="col-md-4">
                                            <p class="mb-0"><strong>Remaining:</strong> â‚¹<span id="remainingNewTestsAmount">0.00</span></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hidden form fields -->
                                <input type="hidden" name="collect_new_tests_payment" id="collectNewTestsPayment" value="0">
                                <input type="hidden" name="new_tests_advance_amount" id="newTestsAdvanceAmount">
                                <input type="hidden" name="new_tests_payment_type" id="newTestsPaymentType">

                                <div class="row" id="newTestsPaymentMethodSection" style="display: none;">
                                    <div class="col-md-6">
                                        <label class="form-label">Payment Method</label>
                                        <select name="new_tests_payment_method" class="form-select" id="newTestsPaymentMethod">
                                            <option value="">Select Payment Method</option>
                                            <option value="cash">Cash</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="upi">UPI</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="cheque">Cheque</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Reference Number</label>
                                        <input type="text" name="new_tests_payment_reference" class="form-control" placeholder="Transaction ID, Receipt #">
                                    </div>
                                </div>

                                <div class="mt-3 text-center">
                                    <button type="button" class="btn btn-secondary me-2" id="cancelNewTestsPayment">
                                        <i class="fas fa-times me-2"></i>Change Payment Option
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="{{ url_for('patients') }}" class="btn btn-secondary me-md-2">Back to Patients</a>
                        <button type="button" class="btn btn-success btn-lg" id="submitAllTestsBtn" onclick="showPaymentModal()">
                            <i class="fas fa-save me-2"></i>Update All Tests & Assign New
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Payment Collection Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="fas fa-credit-card me-2"></i>Collect Payment
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Patient Info -->
                <div class="alert alert-info">
                    <h6><i class="fas fa-user me-2"></i>Patient: {{ patient.full_name }}</h6>
                    <p class="mb-0"><i class="fas fa-phone me-2"></i>Phone: {{ patient.phone }}</p>
                </div>

                <!-- Payment Summary -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Payment Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <span>Existing Tests Updates:</span>
                                    <span id="existingTestsAmount">â‚¹0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>New Tests Assigned:</span>
                                    <span id="newTestsAmount">â‚¹0</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Total Amount:</strong>
                                    <strong id="totalPaymentAmount">â‚¹0</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-money-bill me-2"></i>Payment Options</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="payment_option" value="full" id="fullPayment" checked>
                                    <label class="form-check-label" for="fullPayment">
                                        Full Payment: â‚¹<span id="fullPaymentAmount">0</span>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="payment_option" value="half" id="halfPayment">
                                    <label class="form-check-label" for="halfPayment">
                                        Half Payment: â‚¹<span id="halfPaymentAmount">0</span>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="payment_option" value="custom" id="customPayment">
                                    <label class="form-check-label" for="customPayment">
                                        Custom Amount
                                    </label>
                                </div>
                                <div id="customAmountSection" style="display: none;" class="mt-2">
                                    <div class="input-group">
                                        <span class="input-group-text">â‚¹</span>
                                        <input type="number" class="form-control" id="customAmountInput" placeholder="Enter amount" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="payment_option" value="no_payment" id="noPayment">
                                    <label class="form-check-label" for="noPayment">
                                        No Payment (Update Only)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="card mb-3" id="paymentMethodCard">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Method</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" value="cash" id="cashPayment" checked>
                                    <label class="form-check-label" for="cashPayment">
                                        <i class="fas fa-money-bill-wave me-2"></i>Cash
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" value="card" id="cardPayment">
                                    <label class="form-check-label" for="cardPayment">
                                        <i class="fas fa-credit-card me-2"></i>Card
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" value="upi" id="upiPayment">
                                    <label class="form-check-label" for="upiPayment">
                                        <i class="fas fa-mobile-alt me-2"></i>UPI
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Notes -->
                <div class="mb-3">
                    <label for="paymentNotes" class="form-label">Payment Notes (Optional)</label>
                    <textarea class="form-control" id="paymentNotes" rows="2" placeholder="Add payment notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="processPaymentBtn" onclick="processPaymentAndSubmit()">
                    <i class="fas fa-check me-2"></i>Process Payment & Update
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* Color-coded test result validation styles */
    .test-result-input {
        transition: all 0.3s ease;
    }

    .result-normal {
        background-color: #d4edda !important;
        border-color: #28a745 !important;
        color: #155724 !important;
    }

    .result-high {
        background-color: #f8d7da !important;
        border-color: #dc3545 !important;
        color: #721c24 !important;
    }

    .result-low {
        background-color: #fff3cd !important;
        border-color: #ffc107 !important;
        color: #856404 !important;
    }

    .test-card {
        transition: all 0.3s ease;
    }

    .test-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .status-badge {
        font-size: 0.8em;
    }

    .range-info {
        font-size: 0.85em;
        color: #6c757d;
    }

    /* Modern table styling */
    .modern-table {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
        overflow: hidden;
    }

    .modern-table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8em;
        letter-spacing: 0.5px;
        padding: 15px 8px;
    }

    .modern-table tbody tr {
        border: none;
        transition: all 0.3s ease;
    }

    .modern-table tbody tr:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .modern-table tbody td {
        border: none;
        border-bottom: 1px solid #e9ecef;
        padding: 12px 8px;
        vertical-align: middle;
    }

    .modern-table tbody tr:last-child td {
        border-bottom: none;
    }

    .test-input-modern {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .test-input-modern:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .status-select-modern {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background-color: white;
        font-size: 0.8em;
        font-weight: 500;
    }

    .notes-textarea-modern {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        resize: vertical;
        font-size: 0.8em;
    }

    .unit-badge-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.7em;
    }
</style>

<script>
// Validate test result and apply color coding
function validateResult(input) {
    const value = parseFloat(input.value);
    const min = parseFloat(input.dataset.min);
    const max = parseFloat(input.dataset.max);

    // Remove all result classes
    input.classList.remove('result-normal', 'result-high', 'result-low');

    if (!isNaN(value)) {
        if (value < min) {
            // Low value - Yellow
            input.classList.add('result-low');
        } else if (value > max) {
            // High value - Red
            input.classList.add('result-high');
        } else {
            // Normal value - Green
            input.classList.add('result-normal');
        }
    }
}

// Payment Modal Functions
function showPaymentModal() {
    // Calculate payment amounts
    calculatePaymentAmounts();

    // Show the modal
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    paymentModal.show();
}

function calculatePaymentAmounts() {
    // Calculate new tests cost
    let newTestsCost = 0;
    const checkedNewTests = document.querySelectorAll('.new-test-checkbox:checked');
    checkedNewTests.forEach(checkbox => {
        const cost = parseFloat(checkbox.dataset.cost) || 0;
        newTestsCost += cost;
    });

    // For existing tests, we don't charge additional (just updates)
    const existingTestsCost = 0;

    const totalAmount = existingTestsCost + newTestsCost;

    // Update modal amounts
    document.getElementById('existingTestsAmount').textContent = `â‚¹${existingTestsCost.toFixed(2)}`;
    document.getElementById('newTestsAmount').textContent = `â‚¹${newTestsCost.toFixed(2)}`;
    document.getElementById('totalPaymentAmount').textContent = `â‚¹${totalAmount.toFixed(2)}`;
    document.getElementById('fullPaymentAmount').textContent = totalAmount.toFixed(2);
    document.getElementById('halfPaymentAmount').textContent = (totalAmount / 2).toFixed(2);

    // Show/hide payment method card based on amount
    const paymentMethodCard = document.getElementById('paymentMethodCard');
    if (totalAmount > 0) {
        paymentMethodCard.style.display = 'block';
    } else {
        paymentMethodCard.style.display = 'none';
        // If no payment needed, select "No Payment" option
        document.getElementById('noPayment').checked = true;
    }
}

function processPaymentAndSubmit() {
    const paymentOption = document.querySelector('input[name="payment_option"]:checked').value;
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value || 'cash';
    const paymentNotes = document.getElementById('paymentNotes').value;
    const customAmount = document.getElementById('customAmountInput').value;

    // Add payment data to the form
    const form = document.getElementById('updateTestsForm');

    // Add hidden fields for payment data
    addHiddenField(form, 'payment_option', paymentOption);
    addHiddenField(form, 'payment_method', paymentMethod);
    addHiddenField(form, 'payment_notes', paymentNotes);
    if (paymentOption === 'custom' && customAmount) {
        addHiddenField(form, 'custom_amount', customAmount);
    }

    // Close modal and submit form
    const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
    paymentModal.hide();

    // Submit the form
    form.submit();
}

function addHiddenField(form, name, value) {
    const hiddenField = document.createElement('input');
    hiddenField.type = 'hidden';
    hiddenField.name = name;
    hiddenField.value = value;
    form.appendChild(hiddenField);
}

// Initialize result validation on page load
document.addEventListener('DOMContentLoaded', function() {
    const resultInputs = document.querySelectorAll('.test-result-input');
    resultInputs.forEach(input => {
        if (input.value) {
            validateResult(input);
        }
    });

    // Payment option change handlers
    const paymentOptions = document.querySelectorAll('input[name="payment_option"]');
    paymentOptions.forEach(option => {
        option.addEventListener('change', function() {
            const customAmountSection = document.getElementById('customAmountSection');
            const paymentMethodCard = document.getElementById('paymentMethodCard');

            if (this.value === 'custom') {
                customAmountSection.style.display = 'block';
                paymentMethodCard.style.display = 'block';
            } else if (this.value === 'no_payment') {
                customAmountSection.style.display = 'none';
                paymentMethodCard.style.display = 'none';
            } else {
                customAmountSection.style.display = 'none';
                paymentMethodCard.style.display = 'block';
            }
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    // Color-code rows based on status
    const statusRows = document.querySelectorAll('.test-row');
    statusRows.forEach(row => {
        const status = row.dataset.status;
        if (status === 'Completed') {
            row.classList.add('table-success');
        } else if (status === 'Pending') {
            row.classList.add('table-warning');
        } else if (status === 'Cancelled') {
            row.classList.add('table-secondary');
        }
    });

    // Update row colors when status changes
    const statusSelects = document.querySelectorAll('.status-select');
    statusSelects.forEach(select => {
        select.addEventListener('change', function() {
            const row = this.closest('.test-row');
            row.classList.remove('table-success', 'table-warning', 'table-secondary');
            
            if (this.value === 'Completed') {
                row.classList.add('table-success');
            } else if (this.value === 'Pending') {
                row.classList.add('table-warning');
            } else if (this.value === 'Cancelled') {
                row.classList.add('table-secondary');
            }
        });
    });

    // Quick select common tests
    document.getElementById('selectCommonTests').addEventListener('click', function() {
        const commonTests = ['Blood Test', 'Urine Test', 'Complete Blood Count'];
        const checkboxes = document.querySelectorAll('.new-test-checkbox:not(:disabled)');
        
        checkboxes.forEach(checkbox => {
            const label = checkbox.nextElementSibling.textContent;
            if (commonTests.some(test => label.includes(test))) {
                checkbox.checked = true;
            }
        });
    });

    // Clear all selections
    document.getElementById('clearSelection').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.new-test-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedNewTestsTable();
    });

    // New Tests Selection and Payment System
    const selectedNewTests = new Map();
    let totalNewTestsCost = 0;

    const selectedNewTestsCard = document.getElementById('selectedNewTestsCard');
    const selectedNewTestsTableBody = document.getElementById('selectedNewTestsTableBody');
    const newTestsPaymentCard = document.getElementById('newTestsPaymentCard');

    // Test data for cost calculation
    const testData = {
        {% for test in all_tests %}
        {{ test.id }}: {
            name: "{{ test.name }}",
            category: "{{ test.category }}",
            cost: {{ test.cost }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    // Handle new test selection
    document.querySelectorAll('.new-test-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const testId = this.value;

            if (this.checked && !this.disabled) {
                const test = testData[testId];
                if (test) {
                    selectedNewTests.set(testId, test);
                }
            } else {
                selectedNewTests.delete(testId);
            }

            updateSelectedNewTestsTable();
        });
    });

    function updateSelectedNewTestsTable() {
        selectedNewTestsTableBody.innerHTML = '';
        totalNewTestsCost = 0;

        selectedNewTests.forEach((test, testId) => {
            totalNewTestsCost += test.cost;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${test.name}</td>
                <td><span class="badge bg-secondary">${test.category}</span></td>
                <td>â‚¹${test.cost.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeNewTest('${testId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            selectedNewTestsTableBody.appendChild(row);
        });

        document.getElementById('totalNewTestsCost').textContent = `â‚¹${totalNewTestsCost.toFixed(2)}`;

        if (selectedNewTests.size > 0) {
            selectedNewTestsCard.style.display = 'block';
            newTestsPaymentCard.style.display = 'block';
            updateNewTestsPaymentOptions();
        } else {
            selectedNewTestsCard.style.display = 'none';
            newTestsPaymentCard.style.display = 'none';
        }
    }

    function updateNewTestsPaymentOptions() {
        const halfAmount = totalNewTestsCost / 2;

        document.getElementById('displayNewTestsTotal').textContent = `â‚¹${totalNewTestsCost.toFixed(2)}`;
        document.getElementById('halfNewTestsAmount').textContent = halfAmount.toFixed(2);
        document.getElementById('fullNewTestsAmount').textContent = totalNewTestsCost.toFixed(2);
        document.getElementById('paymentNewTestsTotal').textContent = totalNewTestsCost.toFixed(2);
    }

    // Payment option handlers
    document.getElementById('noPaymentNewTestsBtn').addEventListener('click', function() {
        setNewTestsPaymentOption(0, 'none');
    });

    document.getElementById('halfPaymentNewTestsBtn').addEventListener('click', function() {
        setNewTestsPaymentOption(totalNewTestsCost / 2, 'half');
    });

    document.getElementById('fullPaymentNewTestsBtn').addEventListener('click', function() {
        setNewTestsPaymentOption(totalNewTestsCost, 'full');
    });

    document.getElementById('customPaymentNewTestsBtn').addEventListener('click', function() {
        const customAmount = parseFloat(document.getElementById('customAmountInput').value) || 0;
        if (customAmount <= 0) {
            alert('Please enter a valid amount greater than 0');
            return;
        }
        if (customAmount > totalNewTestsCost) {
            alert('Custom amount cannot be greater than total cost (â‚¹' + totalNewTestsCost.toFixed(2) + ')');
            return;
        }
        setNewTestsPaymentOption(customAmount, 'custom');
    });

    // Real-time validation for custom amount input
    document.getElementById('customAmountInput').addEventListener('input', function() {
        const customAmount = parseFloat(this.value) || 0;
        const customBtn = document.getElementById('customPaymentNewTestsBtn');

        if (customAmount <= 0) {
            customBtn.disabled = true;
            customBtn.innerHTML = '<i class="fas fa-rupee-sign me-2"></i>Enter Amount';
        } else if (customAmount > totalNewTestsCost) {
            customBtn.disabled = true;
            customBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Amount Too High';
        } else {
            customBtn.disabled = false;
            customBtn.innerHTML = '<i class="fas fa-rupee-sign me-2"></i>Pay â‚¹' + customAmount.toFixed(2);
        }
    });

    function setNewTestsPaymentOption(amount, type) {
        const remainingAmount = totalNewTestsCost - amount;

        document.getElementById('payingNewTestsNow').textContent = amount.toFixed(2);
        document.getElementById('remainingNewTestsAmount').textContent = remainingAmount.toFixed(2);

        document.getElementById('collectNewTestsPayment').value = amount > 0 ? '1' : '0';
        document.getElementById('newTestsAdvanceAmount').value = amount.toFixed(2);
        document.getElementById('newTestsPaymentType').value = type;

        document.getElementById('newTestsPaymentDetails').style.display = 'block';

        if (amount > 0) {
            document.getElementById('newTestsPaymentMethodSection').style.display = 'flex';
        } else {
            document.getElementById('newTestsPaymentMethodSection').style.display = 'none';
        }

        // Hide payment option buttons
        document.querySelector('#newTestsPaymentCard .row.mb-4').style.display = 'none';
    }

    document.getElementById('cancelNewTestsPayment').addEventListener('click', function() {
        document.getElementById('newTestsPaymentDetails').style.display = 'none';
        document.querySelector('#newTestsPaymentCard .row.mb-4').style.display = 'flex';

        // Clear form values
        document.getElementById('collectNewTestsPayment').value = '0';
        document.getElementById('newTestsAdvanceAmount').value = '';
        document.getElementById('newTestsPaymentType').value = '';
        document.getElementById('newTestsPaymentMethod').value = '';
    });

    // Global function for removing tests
    window.removeNewTest = function(testId) {
        selectedNewTests.delete(testId);
        document.getElementById(`newTest${testId}`).checked = false;
        updateSelectedNewTestsTable();
    };

    // Form validation
    document.getElementById('updateTestsForm').addEventListener('submit', function(e) {
        const hasChanges = document.querySelectorAll('.new-test-checkbox:checked').length > 0 ||
                          document.querySelectorAll('textarea, select').length > 0;

        if (!hasChanges) {
            if (!confirm('No changes detected. Are you sure you want to submit?')) {
                e.preventDefault();
            }
        }
    });
});
</script>
{% endblock %}
