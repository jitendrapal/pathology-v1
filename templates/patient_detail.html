{% extends "base.html" %}

{% block title %}{{ patient.full_name }} - Patient Details - Pathology Lab{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-user me-2"></i>{{ patient.full_name }} - Patient Details
            </h1>
            <div class="btn-group">
                <a href="{{ url_for('edit_patient', id=patient.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-edit me-2"></i>Edit Patient
                </a>
                <a href="{{ url_for('patient_billing', patient_id=patient.id) }}" class="btn btn-warning">
                    <i class="fas fa-dollar-sign me-2"></i>Billing & Payments
                </a>
                <div class="btn-group">
                    <a href="{{ url_for('patient_report', patient_id=patient.id) }}" class="btn btn-info" target="_blank">
                        <i class="fas fa-print me-2"></i>Print Report
                    </a>
                    <a href="{{ url_for('print_patient_report', patient_id=patient.id) }}" class="btn btn-success" target="_blank">
                        <i class="fas fa-file-medical me-2"></i>Print Test Results
                    </a>
                </div>
                <a href="{{ url_for('patients') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Patients
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Patient Information Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user-circle me-2"></i>Patient Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Name:</strong> {{ patient.full_name }}</p>
                        <p><strong>Age:</strong> {{ patient.age }} years</p>
                        <p><strong>Gender:</strong> {{ patient.gender }}</p>
                        <p><strong>Phone:</strong> {{ patient.phone }}</p>
                        {% if patient.email %}
                        <p><strong>Email:</strong> {{ patient.email }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <p><strong>Address:</strong><br>{{ patient.address }}</p>
                        {% if patient.hospital_name %}
                        <p><strong>Hospital:</strong> {{ patient.hospital_name }}</p>
                        {% endif %}
                        {% if patient.collected_by %}
                        <p><strong>Sample Collected By:</strong> {{ patient.collected_by }}</p>
                        {% endif %}
                        <p><strong>Registration Date:</strong> {{ patient.date_registered.strftime('%Y-%m-%d') }}</p>
                    </div>
                </div>
                {% if patient.medical_history %}
                <div class="row">
                    <div class="col-12">
                        <p><strong>Medical History:</strong><br>{{ patient.medical_history }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Test Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white text-center">
            <div class="card-body">
                <h4>{{ patient_tests|length }}</h4>
                <p class="mb-0">Total Tests</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white text-center">
            <div class="card-body">
                <h4>{{ patient_tests|selectattr("status", "equalto", "Pending")|list|length }}</h4>
                <p class="mb-0">Pending</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white text-center">
            <div class="card-body">
                <h4>{{ patient_tests|selectattr("status", "equalto", "Completed")|list|length }}</h4>
                <p class="mb-0">Completed</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white text-center">
            <div class="card-body">
                <h4>${{ "%.2f"|format(patient_tests|sum(attribute="test.cost")) }}</h4>
                <p class="mb-0">Total Cost</p>
            </div>
        </div>
    </div>
</div>

<!-- All Patient Tests - Update in One Place -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-flask me-2"></i>All Assigned Tests - Update Status & Results
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('update_patient_tests', patient_id=patient.id) }}" id="updateTestsForm">
                    
                    {% if patient_tests %}
                    <!-- Existing Tests -->
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-list me-2"></i>Current Tests ({{ patient_tests|length }})
                    </h6>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 20%;">Test Name</th>
                                    <th style="width: 10%;">Category</th>
                                    <th style="width: 12%;">Date Ordered</th>
                                    <th style="width: 12%;">Status</th>
                                    <th style="width: 25%;">Results</th>
                                    <th style="width: 15%;">Notes</th>
                                    <th style="width: 6%;">Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pt in patient_tests %}
                                <tr class="test-row" data-status="{{ pt.status }}">
                                    <td>
                                        <strong>{{ pt.test.name }}</strong>
                                        {% if pt.test.normal_range %}
                                        <br><small class="text-muted">Normal: {{ pt.test.normal_range }}</small>
                                        {% endif %}
                                        <input type="hidden" name="test_ids[]" value="{{ pt.id }}">
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ pt.test.category or 'N/A' }}</span>
                                    </td>
                                    <td>
                                        <small>{{ pt.date_ordered.strftime('%Y-%m-%d %H:%M') }}</small>
                                        {% if pt.date_completed %}
                                        <br><small class="text-success">Completed: {{ pt.date_completed.strftime('%Y-%m-%d %H:%M') }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <select name="statuses[]" class="form-select form-select-sm status-select">
                                            <option value="Pending" {{ 'selected' if pt.status == 'Pending' }}>Pending</option>
                                            <option value="Completed" {{ 'selected' if pt.status == 'Completed' }}>Completed</option>
                                            <option value="Cancelled" {{ 'selected' if pt.status == 'Cancelled' }}>Cancelled</option>
                                        </select>
                                    </td>
                                    <td>
                                        <textarea name="results[]" class="form-control form-control-sm" rows="2" 
                                                placeholder="Enter test results...">{{ pt.results or '' }}</textarea>
                                    </td>
                                    <td>
                                        <textarea name="notes[]" class="form-control form-control-sm" rows="2" 
                                                placeholder="Additional notes...">{{ pt.notes or '' }}</textarea>
                                    </td>
                                    <td>
                                        <strong class="text-success">${{ "%.2f"|format(pt.test.cost) }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <h6>No tests assigned yet</h6>
                        <p class="mb-0">Use the section below to assign new tests to this patient.</p>
                    </div>
                    {% endif %}

                    <!-- Add New Tests Section -->
                    <hr class="my-4">
                    <h6 class="text-success mb-3">
                        <i class="fas fa-plus me-2"></i>Assign New Tests
                    </h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Sample Collector (for new tests)</label>
                            <select name="sample_collector" class="form-select">
                                <option value="">Select Sample Collector</option>
                                {% for collector in collectors %}
                                <option value="{{ collector.name }}">{{ collector.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quick Actions</label>
                            <div class="btn-group w-100">
                                <button type="button" class="btn btn-outline-primary" id="selectCommonTests">
                                    <i class="fas fa-check-double me-1"></i>Select Common Tests
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="clearSelection">
                                    <i class="fas fa-times me-1"></i>Clear Selection
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Available Tests Grid -->
                    <div class="row" id="newTestsGrid">
                        {% for test in all_tests %}
                        {% set is_assigned = patient_tests|selectattr("test.id", "equalto", test.id)|list|length > 0 %}
                        <div class="col-md-6 col-lg-4 mb-2">
                            <div class="card h-100 {{ 'border-secondary bg-light' if is_assigned else '' }}">
                                <div class="card-body p-2">
                                    <div class="form-check">
                                        <input class="form-check-input new-test-checkbox" type="checkbox" 
                                               value="{{ test.id }}" id="newTest{{ test.id }}"
                                               name="new_test_ids[]" {{ 'disabled' if is_assigned else '' }}>
                                        <label class="form-check-label w-100" for="newTest{{ test.id }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title mb-1 {{ 'text-muted' if is_assigned else '' }}">
                                                        {{ test.name }}
                                                        {% if is_assigned %}<small class="text-success">(Already Assigned)</small>{% endif %}
                                                    </h6>
                                                    {% if test.category %}
                                                    <span class="badge bg-secondary mb-1">{{ test.category }}</span>
                                                    {% endif %}
                                                    <div class="small">
                                                        <strong class="text-success">₹{{ "%.2f"|format(test.cost) }}</strong>
                                                        {% if test.normal_range %}
                                                        <br><span class="text-muted">{{ test.normal_range }}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Selected New Tests Table -->
                    <div class="card mt-4" id="selectedNewTestsCard" style="display: none;">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-list me-2"></i>Selected New Tests
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Category</th>
                                            <th>Cost (₹)</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="selectedNewTestsTableBody">
                                        <!-- Selected tests will be added here -->
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <th colspan="2">Total New Tests Cost:</th>
                                            <th id="totalNewTestsCost">₹0.00</th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Options for New Tests -->
                    <div class="card mt-4" id="newTestsPaymentCard" style="display: none;">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-credit-card me-2"></i>Payment Options for New Tests
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Total Amount Display -->
                            <div class="alert alert-info text-center mb-4">
                                <h5 class="mb-0">
                                    <i class="fas fa-calculator me-2"></i>Total New Tests Cost: <span id="displayNewTestsTotal">₹0.00</span>
                                </h5>
                            </div>

                            <!-- Payment Options -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card border-secondary h-100">
                                        <div class="card-header bg-secondary text-white text-center">
                                            <h6 class="mb-0"><i class="fas fa-clock me-2"></i>No Payment Now</h6>
                                        </div>
                                        <div class="card-body text-center">
                                            <h6 class="text-secondary mb-3">₹0.00</h6>
                                            <button type="button" class="btn btn-secondary btn-sm" id="noPaymentNewTestsBtn">
                                                <i class="fas fa-forward me-2"></i>Assign Without Payment
                                            </button>
                                            <p class="small text-muted mt-2">Full payment will be collected later</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark text-center">
                                            <h6 class="mb-0"><i class="fas fa-hand-holding-usd me-2"></i>Half Payment</h6>
                                        </div>
                                        <div class="card-body text-center">
                                            <h6 class="text-warning mb-3">₹<span id="halfNewTestsAmount">0.00</span></h6>
                                            <button type="button" class="btn btn-warning btn-sm" id="halfPaymentNewTestsBtn">
                                                <i class="fas fa-credit-card me-2"></i>Pay Half Now
                                            </button>
                                            <p class="small text-muted mt-2">50% of total amount</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-success h-100">
                                        <div class="card-header bg-success text-white text-center">
                                            <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Full Payment</h6>
                                        </div>
                                        <div class="card-body text-center">
                                            <h6 class="text-success mb-3">₹<span id="fullNewTestsAmount">0.00</span></h6>
                                            <button type="button" class="btn btn-success btn-sm" id="fullPaymentNewTestsBtn">
                                                <i class="fas fa-money-check-alt me-2"></i>Pay Full Now
                                            </button>
                                            <p class="small text-muted mt-2">100% of total amount</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-info h-100">
                                        <div class="card-header bg-info text-white text-center">
                                            <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Custom Amount</h6>
                                        </div>
                                        <div class="card-body text-center">
                                            <div class="input-group input-group-sm mb-3">
                                                <span class="input-group-text">₹</span>
                                                <input type="number" class="form-control" id="customAmountInput" placeholder="0.00" min="0" step="0.01" max="999999">
                                            </div>
                                            <button type="button" class="btn btn-info btn-sm" id="customPaymentNewTestsBtn">
                                                <i class="fas fa-rupee-sign me-2"></i>Pay Custom Amount
                                            </button>
                                            <p class="small text-muted mt-2">Enter any amount you want</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Details Form -->
                            <div id="newTestsPaymentDetails" style="display: none;">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-info-circle me-2"></i>Payment Summary</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <p class="mb-1"><strong>Total Cost:</strong> ₹<span id="paymentNewTestsTotal">0.00</span></p>
                                        </div>
                                        <div class="col-md-4">
                                            <p class="mb-1"><strong>Paying Now:</strong> ₹<span id="payingNewTestsNow">0.00</span></p>
                                        </div>
                                        <div class="col-md-4">
                                            <p class="mb-0"><strong>Remaining:</strong> ₹<span id="remainingNewTestsAmount">0.00</span></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hidden form fields -->
                                <input type="hidden" name="collect_new_tests_payment" id="collectNewTestsPayment" value="0">
                                <input type="hidden" name="new_tests_advance_amount" id="newTestsAdvanceAmount">
                                <input type="hidden" name="new_tests_payment_type" id="newTestsPaymentType">

                                <div class="row" id="newTestsPaymentMethodSection" style="display: none;">
                                    <div class="col-md-6">
                                        <label class="form-label">Payment Method</label>
                                        <select name="new_tests_payment_method" class="form-select" id="newTestsPaymentMethod">
                                            <option value="">Select Payment Method</option>
                                            <option value="cash">Cash</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="upi">UPI</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="cheque">Cheque</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Reference Number</label>
                                        <input type="text" name="new_tests_payment_reference" class="form-control" placeholder="Transaction ID, Receipt #">
                                    </div>
                                </div>

                                <div class="mt-3 text-center">
                                    <button type="button" class="btn btn-secondary me-2" id="cancelNewTestsPayment">
                                        <i class="fas fa-times me-2"></i>Change Payment Option
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="{{ url_for('patients') }}" class="btn btn-secondary me-md-2">Back to Patients</a>
                        <button type="submit" class="btn btn-success btn-lg" id="submitAllTestsBtn">
                            <i class="fas fa-save me-2"></i>Update All Tests & Assign New
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Color-code rows based on status
    const statusRows = document.querySelectorAll('.test-row');
    statusRows.forEach(row => {
        const status = row.dataset.status;
        if (status === 'Completed') {
            row.classList.add('table-success');
        } else if (status === 'Pending') {
            row.classList.add('table-warning');
        } else if (status === 'Cancelled') {
            row.classList.add('table-secondary');
        }
    });

    // Update row colors when status changes
    const statusSelects = document.querySelectorAll('.status-select');
    statusSelects.forEach(select => {
        select.addEventListener('change', function() {
            const row = this.closest('.test-row');
            row.classList.remove('table-success', 'table-warning', 'table-secondary');
            
            if (this.value === 'Completed') {
                row.classList.add('table-success');
            } else if (this.value === 'Pending') {
                row.classList.add('table-warning');
            } else if (this.value === 'Cancelled') {
                row.classList.add('table-secondary');
            }
        });
    });

    // Quick select common tests
    document.getElementById('selectCommonTests').addEventListener('click', function() {
        const commonTests = ['Blood Test', 'Urine Test', 'Complete Blood Count'];
        const checkboxes = document.querySelectorAll('.new-test-checkbox:not(:disabled)');
        
        checkboxes.forEach(checkbox => {
            const label = checkbox.nextElementSibling.textContent;
            if (commonTests.some(test => label.includes(test))) {
                checkbox.checked = true;
            }
        });
    });

    // Clear all selections
    document.getElementById('clearSelection').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.new-test-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedNewTestsTable();
    });

    // New Tests Selection and Payment System
    const selectedNewTests = new Map();
    let totalNewTestsCost = 0;

    const selectedNewTestsCard = document.getElementById('selectedNewTestsCard');
    const selectedNewTestsTableBody = document.getElementById('selectedNewTestsTableBody');
    const newTestsPaymentCard = document.getElementById('newTestsPaymentCard');

    // Test data for cost calculation
    const testData = {
        {% for test in all_tests %}
        {{ test.id }}: {
            name: "{{ test.name }}",
            category: "{{ test.category }}",
            cost: {{ test.cost }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    // Handle new test selection
    document.querySelectorAll('.new-test-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const testId = this.value;

            if (this.checked && !this.disabled) {
                const test = testData[testId];
                if (test) {
                    selectedNewTests.set(testId, test);
                }
            } else {
                selectedNewTests.delete(testId);
            }

            updateSelectedNewTestsTable();
        });
    });

    function updateSelectedNewTestsTable() {
        selectedNewTestsTableBody.innerHTML = '';
        totalNewTestsCost = 0;

        selectedNewTests.forEach((test, testId) => {
            totalNewTestsCost += test.cost;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${test.name}</td>
                <td><span class="badge bg-secondary">${test.category}</span></td>
                <td>₹${test.cost.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeNewTest('${testId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            selectedNewTestsTableBody.appendChild(row);
        });

        document.getElementById('totalNewTestsCost').textContent = `₹${totalNewTestsCost.toFixed(2)}`;

        if (selectedNewTests.size > 0) {
            selectedNewTestsCard.style.display = 'block';
            newTestsPaymentCard.style.display = 'block';
            updateNewTestsPaymentOptions();
        } else {
            selectedNewTestsCard.style.display = 'none';
            newTestsPaymentCard.style.display = 'none';
        }
    }

    function updateNewTestsPaymentOptions() {
        const halfAmount = totalNewTestsCost / 2;

        document.getElementById('displayNewTestsTotal').textContent = `₹${totalNewTestsCost.toFixed(2)}`;
        document.getElementById('halfNewTestsAmount').textContent = halfAmount.toFixed(2);
        document.getElementById('fullNewTestsAmount').textContent = totalNewTestsCost.toFixed(2);
        document.getElementById('paymentNewTestsTotal').textContent = totalNewTestsCost.toFixed(2);
    }

    // Payment option handlers
    document.getElementById('noPaymentNewTestsBtn').addEventListener('click', function() {
        setNewTestsPaymentOption(0, 'none');
    });

    document.getElementById('halfPaymentNewTestsBtn').addEventListener('click', function() {
        setNewTestsPaymentOption(totalNewTestsCost / 2, 'half');
    });

    document.getElementById('fullPaymentNewTestsBtn').addEventListener('click', function() {
        setNewTestsPaymentOption(totalNewTestsCost, 'full');
    });

    document.getElementById('customPaymentNewTestsBtn').addEventListener('click', function() {
        const customAmount = parseFloat(document.getElementById('customAmountInput').value) || 0;
        if (customAmount <= 0) {
            alert('Please enter a valid amount greater than 0');
            return;
        }
        if (customAmount > totalNewTestsCost) {
            alert('Custom amount cannot be greater than total cost (₹' + totalNewTestsCost.toFixed(2) + ')');
            return;
        }
        setNewTestsPaymentOption(customAmount, 'custom');
    });

    // Real-time validation for custom amount input
    document.getElementById('customAmountInput').addEventListener('input', function() {
        const customAmount = parseFloat(this.value) || 0;
        const customBtn = document.getElementById('customPaymentNewTestsBtn');

        if (customAmount <= 0) {
            customBtn.disabled = true;
            customBtn.innerHTML = '<i class="fas fa-rupee-sign me-2"></i>Enter Amount';
        } else if (customAmount > totalNewTestsCost) {
            customBtn.disabled = true;
            customBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Amount Too High';
        } else {
            customBtn.disabled = false;
            customBtn.innerHTML = '<i class="fas fa-rupee-sign me-2"></i>Pay ₹' + customAmount.toFixed(2);
        }
    });

    function setNewTestsPaymentOption(amount, type) {
        const remainingAmount = totalNewTestsCost - amount;

        document.getElementById('payingNewTestsNow').textContent = amount.toFixed(2);
        document.getElementById('remainingNewTestsAmount').textContent = remainingAmount.toFixed(2);

        document.getElementById('collectNewTestsPayment').value = amount > 0 ? '1' : '0';
        document.getElementById('newTestsAdvanceAmount').value = amount.toFixed(2);
        document.getElementById('newTestsPaymentType').value = type;

        document.getElementById('newTestsPaymentDetails').style.display = 'block';

        if (amount > 0) {
            document.getElementById('newTestsPaymentMethodSection').style.display = 'flex';
        } else {
            document.getElementById('newTestsPaymentMethodSection').style.display = 'none';
        }

        // Hide payment option buttons
        document.querySelector('#newTestsPaymentCard .row.mb-4').style.display = 'none';
    }

    document.getElementById('cancelNewTestsPayment').addEventListener('click', function() {
        document.getElementById('newTestsPaymentDetails').style.display = 'none';
        document.querySelector('#newTestsPaymentCard .row.mb-4').style.display = 'flex';

        // Clear form values
        document.getElementById('collectNewTestsPayment').value = '0';
        document.getElementById('newTestsAdvanceAmount').value = '';
        document.getElementById('newTestsPaymentType').value = '';
        document.getElementById('newTestsPaymentMethod').value = '';
    });

    // Global function for removing tests
    window.removeNewTest = function(testId) {
        selectedNewTests.delete(testId);
        document.getElementById(`newTest${testId}`).checked = false;
        updateSelectedNewTestsTable();
    };

    // Form validation
    document.getElementById('updateTestsForm').addEventListener('submit', function(e) {
        const hasChanges = document.querySelectorAll('.new-test-checkbox:checked').length > 0 ||
                          document.querySelectorAll('textarea, select').length > 0;

        if (!hasChanges) {
            if (!confirm('No changes detected. Are you sure you want to submit?')) {
                e.preventDefault();
            }
        }
    });
});
</script>
{% endblock %}
