<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Report - {{ patient.full_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { font-size: 12px; }
            .page-break { page-break-before: always; }
        }
        
        .report-header {
            border-bottom: 3px solid #007bff;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }
        
        .lab-logo {
            width: 80px;
            height: 80px;
            background: #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        .patient-info {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .test-results {
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .test-header {
            background: #e9ecef;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }
        
        .test-content {
            padding: 15px;
        }
        
        .normal-range {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .signature-section {
            margin-top: 50px;
            border-top: 1px solid #dee2e6;
            padding-top: 30px;
        }
        
        .signature-box {
            border: 1px solid #dee2e6;
            height: 80px;
            margin-top: 10px;
            position: relative;
        }
        
        .signature-label {
            position: absolute;
            bottom: 5px;
            left: 10px;
            font-size: 0.8em;
            color: #6c757d;
        }
        
        .report-footer {
            margin-top: 30px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }
        
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Print Button (hidden when printing) -->
        <div class="no-print mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-file-medical me-2"></i>Test Report</h4>
                <div>
                    <button onclick="window.print()" class="btn btn-primary">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                    <a href="{{ url_for('edit_patient_test', id=patient_test.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Test
                    </a>
                </div>
            </div>
            <hr>
        </div>

        <!-- Report Header -->
        <div class="report-header">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <div class="lab-logo">
                        <i class="fas fa-microscope"></i>
                    </div>
                </div>
                <div class="col-md-8">
                    <h2 class="mb-1">PATHOLOGY LAB MANAGEMENT SYSTEM</h2>
                    <p class="mb-1"><strong>Address:</strong> 123 Medical Center Drive, Healthcare City, HC 12345</p>
                    <p class="mb-1"><strong>Phone:</strong> (555) 123-4567 | <strong>Email:</strong> info@pathologylab.com</p>
                    <p class="mb-0"><strong>License No:</strong> PL-2024-001 | <strong>NABL Accredited</strong></p>
                </div>
                <div class="col-md-2 text-end">
                    <h5 class="text-primary">TEST REPORT</h5>
                    <p class="mb-0"><strong>Report ID:</strong> RPT-{{ patient_test.id }}</p>
                    <p class="mb-0"><strong>Date:</strong> {{ patient_test.date_completed.strftime('%d/%m/%Y') if patient_test.date_completed else 'N/A' }}</p>
                </div>
            </div>
        </div>

        <!-- Patient Information -->
        <div class="patient-info">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-primary mb-3"><i class="fas fa-user me-2"></i>Patient Information</h5>
                    <p class="mb-1"><strong>Name:</strong> {{ patient.full_name }}</p>
                    <p class="mb-1"><strong>Age:</strong> {{ patient.age }} years</p>
                    <p class="mb-1"><strong>Gender:</strong> {{ patient.gender }}</p>
                    <p class="mb-1"><strong>Phone:</strong> {{ patient.phone }}</p>
                    {% if patient.email %}
                    <p class="mb-1"><strong>Email:</strong> {{ patient.email }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <h5 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Test Information</h5>
                    <p class="mb-1"><strong>Patient ID:</strong> {{ patient.id }}</p>
                    <p class="mb-1"><strong>Date Ordered:</strong> {{ patient_test.date_ordered.strftime('%d/%m/%Y') }}</p>
                    <p class="mb-1"><strong>Date Completed:</strong> {{ patient_test.date_completed.strftime('%d/%m/%Y %H:%M') if patient_test.date_completed else 'N/A' }}</p>
                    <p class="mb-1"><strong>Sample Collector:</strong> {{ patient_test.sample_collector or 'N/A' }}</p>
                    {% if patient.medical_history %}
                    <p class="mb-1"><strong>Medical History:</strong> {{ patient.medical_history[:100] }}{% if patient.medical_history|length > 100 %}...{% endif %}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <h5 class="text-primary mb-3"><i class="fas fa-flask me-2"></i>Test Results</h5>
        
        {% for test in all_completed_tests %}
        <div class="test-results">
            <div class="test-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-0">{{ test.test.name }}</h6>
                        {% if test.test.description %}
                        <small class="text-muted">{{ test.test.description }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="status-badge status-{{ test.status.lower() }}">{{ test.status }}</span>
                        <small class="text-muted ms-2">Cost: ₹{{ "%.2f"|format(test.test.cost) }}</small>
                    </div>
                </div>
            </div>
            <div class="test-content">
                {% if test.results %}
                <div class="row">
                    <div class="col-md-8">
                        <h6>Results:</h6>
                        <div class="border p-3 bg-light">
                            {{ test.results|replace('\n', '<br>')|safe }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        {% if test.test.normal_range %}
                        <h6>Normal Range:</h6>
                        <div class="normal-range">
                            {{ test.test.normal_range }}
                        </div>
                        {% endif %}
                        {% if test.notes %}
                        <h6 class="mt-3">Notes:</h6>
                        <div class="normal-range">
                            {{ test.notes }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <p class="text-muted">Results not available</p>
                {% endif %}
                
                {% if test.date_completed %}
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>Completed on: {{ test.date_completed.strftime('%d/%m/%Y at %H:%M') }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <!-- Payment Information -->
        {% if patient_bill %}
        <div class="row mt-4">
            <div class="col-md-6">
                <h5 class="text-primary mb-3"><i class="fas fa-receipt me-2"></i>Billing Summary</h5>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Total Amount:</strong></td>
                        <td class="text-end">₹{{ "%.2f"|format(patient_bill.total_amount) }}</td>
                    </tr>
                    {% if patient_bill.discount_amount > 0 %}
                    <tr>
                        <td><strong>Discount:</strong></td>
                        <td class="text-end text-success">-₹{{ "%.2f"|format(patient_bill.discount_amount) }}</td>
                    </tr>
                    <tr>
                        <td><strong>Final Amount:</strong></td>
                        <td class="text-end">₹{{ "%.2f"|format(patient_bill.final_amount) }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td><strong>Paid Amount:</strong></td>
                        <td class="text-end text-success">₹{{ "%.2f"|format(patient_bill.paid_amount) }}</td>
                    </tr>
                    <tr class="table-active">
                        <td><strong>Payment Status:</strong></td>
                        <td class="text-end">
                            <span class="badge bg-{{ 'success' if patient_bill.payment_status == 'Fully Paid' else 'warning' }}">
                                {{ patient_bill.payment_status }}
                            </span>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h5 class="text-primary mb-3"><i class="fas fa-credit-card me-2"></i>Payment History</h5>
                {% if payments %}
                <div style="max-height: 200px; overflow-y: auto;">
                    {% for payment in payments %}
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <span><strong>₹{{ "%.2f"|format(payment.amount) }}</strong></span>
                            <small class="text-muted">{{ payment.payment_date.strftime('%d/%m/%Y') }}</small>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small>{{ payment.payment_method.title() }}</small>
                            {% if payment.reference_number %}
                            <small class="text-muted">Ref: {{ payment.reference_number }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No payment records found.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Signature Section -->
        <div class="signature-section">
            <div class="row">
                <div class="col-md-6">
                    <h6>Pathologist Signature</h6>
                    <div class="signature-box">
                        <div class="signature-label">Dr. [Pathologist Name]<br>MD Pathology, License: [License No.]</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Lab Technician Signature</h6>
                    <div class="signature-box">
                        <div class="signature-label">{{ patient_test.sample_collector or '[Lab Technician Name]' }}<br>Certified Lab Technician</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Footer -->
        <div class="report-footer">
            <hr>
            <p class="mb-1"><strong>Important Notes:</strong></p>
            <p class="mb-1">• This report is valid only with authorized signatures and lab seal.</p>
            <p class="mb-1">• Results are based on the sample provided and testing methodology used.</p>
            <p class="mb-1">• For any queries, please contact the laboratory within 7 days of report generation.</p>
            <p class="mb-0">• This is a computer-generated report and does not require a physical signature if digitally verified.</p>
            
            <div class="mt-3">
                <small class="text-muted">
                    Report generated on {{ moment().format('DD/MM/YYYY HH:mm') if moment else 'N/A' }} | 
                    Report ID: RPT-{{ patient_test.id }} | 
                    Patient ID: {{ patient.id }}
                </small>
            </div>
        </div>
    </div>

    <script>
        // Auto-print when page loads (optional)
        // window.onload = function() { window.print(); }
        
        // Print function
        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
