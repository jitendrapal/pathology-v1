<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Receipt - {{ patient.full_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { font-size: 12px; }
        }
        
        .receipt-header {
            border-bottom: 2px solid #007bff;
            margin-bottom: 20px;
            padding-bottom: 15px;
        }
        
        .bill-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 20px 0;
        }
        
        .amount-highlight {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .pending-amount {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Print Button -->
        <div class="no-print mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-receipt me-2"></i>Bill Receipt</h4>
                <div>
                    <button onclick="window.print()" class="btn btn-primary">
                        <i class="fas fa-print me-2"></i>Print Bill
                    </button>
                    <a href="{{ url_for('patient_billing', patient_id=patient.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back
                    </a>
                </div>
            </div>
            <hr>
        </div>

        <!-- Receipt Header -->
        <div class="receipt-header text-center">
            <h2>PATHOLOGY LAB MANAGEMENT SYSTEM</h2>
            <p class="mb-1">123 Medical Center Drive, Healthcare City, HC 12345</p>
            <p class="mb-1">Phone: (555) 123-4567 | Email: info@pathologylab.com</p>
            <p class="mb-0">License No: PL-2024-001</p>
        </div>

        <!-- Bill Information -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h5>Bill To:</h5>
                <p class="mb-1"><strong>{{ patient.full_name }}</strong></p>
                <p class="mb-1">Age: {{ patient.age }} years | Gender: {{ patient.gender }}</p>
                <p class="mb-1">Phone: {{ patient.phone }}</p>
                {% if patient.email %}
                <p class="mb-1">Email: {{ patient.email }}</p>
                {% endif %}
                <p class="mb-0">Patient ID: {{ patient.id }}</p>
            </div>
            <div class="col-md-6 text-end">
                <h5>Bill Details:</h5>
                <p class="mb-1"><strong>Bill Date:</strong> {{ patient_bill.bill_date.strftime('%d/%m/%Y') if patient_bill.bill_date else 'N/A' }}</p>
                <p class="mb-1"><strong>Bill ID:</strong> BILL-{{ patient.id }}-{{ patient_bill.id if patient_bill else 'N/A' }}</p>
                <p class="mb-0"><strong>Status:</strong> 
                    <span class="badge bg-{{ 'success' if patient_bill and patient_bill.payment_status == 'Fully Paid' else 'warning' }}">
                        {{ patient_bill.payment_status if patient_bill else 'Pending' }}
                    </span>
                </p>
            </div>
        </div>

        <!-- Test Details -->
        <h5>Test Details:</h5>
        <div class="table-responsive mb-4">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Test Name</th>
                        <th>Date Ordered</th>
                        <th>Status</th>
                        <th class="text-end">Cost</th>
                    </tr>
                </thead>
                <tbody>
                    {% for test_order in patient_tests %}
                    <tr>
                        <td>{{ test_order.test.name }}</td>
                        <td>{{ test_order.date_ordered.strftime('%d/%m/%Y') }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if test_order.status == 'Completed' else 'warning' if test_order.status == 'Pending' else 'secondary' }}">
                                {{ test_order.status }}
                            </span>
                        </td>
                        <td class="text-end">₹{{ "%.2f"|format(test_order.test.cost) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th colspan="3">Total Amount:</th>
                        <th class="text-end">₹{{ "%.2f"|format(patient_bill.total_amount if patient_bill else 0) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Payment Summary -->
        {% if patient_bill %}
        <div class="bill-summary">
            <h5 class="mb-3">Payment Summary:</h5>
            <div class="row">
                <div class="col-md-4">
                    <p class="mb-2"><strong>Total Amount:</strong></p>
                    <p class="amount-highlight text-primary">₹{{ "%.2f"|format(patient_bill.total_amount) }}</p>
                </div>
                <div class="col-md-4">
                    <p class="mb-2"><strong>Paid Amount:</strong></p>
                    <p class="amount-highlight text-success">₹{{ "%.2f"|format(patient_bill.paid_amount) }}</p>
                </div>
                <div class="col-md-4">
                    <p class="mb-2"><strong>Remaining Amount:</strong></p>
                    <p class="amount-highlight text-{{ 'success' if patient_bill.remaining_amount == 0 else 'danger' }}">₹{{ "%.2f"|format(patient_bill.remaining_amount) }}</p>
                </div>
            </div>
            
            {% if patient_bill.remaining_amount > 0 %}
            <div class="pending-amount mt-3">
                <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Payment Pending</h6>
                <p class="mb-1">Please collect the remaining amount of <strong>₹{{ "%.2f"|format(patient_bill.remaining_amount) }}</strong></p>
                <p class="mb-0 small">Payment can be made in cash, card, UPI, or bank transfer</p>
            </div>
            {% else %}
            <div class="alert alert-success mt-3">
                <h6 class="text-success"><i class="fas fa-check-circle me-2"></i>Payment Complete</h6>
                <p class="mb-0">All payments have been received. Test reports can be printed.</p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Payment History -->
        {% if payments %}
        <h5>Payment History:</h5>
        <div class="table-responsive mb-4">
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Reference</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr>
                        <td>{{ payment.payment_date.strftime('%d/%m/%Y') }}</td>
                        <td class="text-success">₹{{ "%.2f"|format(payment.amount) }}</td>
                        <td>{{ payment.payment_method.title() }}</td>
                        <td>{{ payment.reference_number or 'N/A' }}</td>
                        <td>
                            <span class="badge bg-info">{{ payment.payment_type.title() }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Footer -->
        <div class="text-center mt-5 pt-3 border-top">
            <p class="mb-1"><strong>Thank you for choosing our pathology services!</strong></p>
            <p class="mb-1">For any queries, please contact us at (555) 123-4567</p>
            <p class="mb-0 small text-muted">This is a computer-generated bill and does not require a signature</p>
        </div>
    </div>

    <script>
        // Auto-print option
        // window.onload = function() { window.print(); }
    </script>
</body>
</html>
